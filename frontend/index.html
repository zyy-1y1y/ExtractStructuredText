<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ–‡æœ¬æŠ½å– | å‰ç«¯</title>
  <style>
    body{font-family: Arial, Helvetica, sans-serif; margin:20px;}
    textarea{width:100%;height:120px}
    .doc{border:1px solid #ddd;padding:10px;margin-bottom:8px;border-radius:6px}
    .btn{display:inline-block;padding:8px 12px;border-radius:6px;background:#2b8cff;color:#fff;text-decoration:none;cursor:pointer}
    .small{font-size:0.9em;color:#666}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #eee;padding:8px}
  </style>
</head>
<body>
  <div id="app">
    <h2>æ–‡æœ¬æŠ½å–ï¼ˆæœ¬åœ°æˆ–åµŒå…¥ï¼‰</h2>
    <p class="small">è¯´æ˜ï¼šå°†éç»“æ„åŒ–æ–‡æœ¬ç²˜è´´åˆ°ä¸‹æ–¹ï¼Œç‚¹å‡»â€œå¤„ç†â€ã€‚</p>

    <div>
      <label>Doc ID: <input v-model="docId" /></label>
    </div>
    <div style="margin-top:8px">
      <textarea v-model="rawText" placeholder="åœ¨æ­¤ç²˜è´´æ£€æŸ¥æŠ¥å‘Šæˆ–ç—…å†åŸæ–‡..."></textarea>
    </div>
    <div style="margin-top:8px">
      <button class="btn" @click="processSingle">å¤„ç†å½“å‰æ–‡æœ¬</button>
      <button class="btn" style="background:#4caf50;margin-left:8px" @click="batchProcess">å¤„ç†ç¤ºä¾‹æ‰¹é‡</button>
      <button class="btn" style="background:#777;margin-left:8px" @click="downloadStructured">ä¸‹è½½ JSON</button>
    </div>

    <h3 style="margin-top:20px">å¤„ç†ç»“æœ</h3>
    <div v-if="results.length===0"><em>æš‚æ— ç»“æœ</em></div>
    <div v-for="r in results" :key="r.doc_id" class="doc">
      <strong>{{r.doc_id}}</strong>
      <div class="small">{{r.raw_text}}</div>
      <div style="margin-top:8px">
        <table>
          <thead><tr><th>å‚æ•°å</th><th>å€¼</th></tr></thead>
          <tbody>
            <tr v-for="e in r.extracted" :key="e.param_name">
              <td>{{e.param_name}}</td>
              <td>{{e.param_value}}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="margin-top:8px">
        <span class="small">çŠ¶æ€: {{r.status}}</span>
        <button style="margin-left:8px" @click="markFailure(r)">æ ‡æ³¨ä¸ºå¤±è´¥å¹¶æ·»åŠ äººå·¥æ³¨é‡Š</button>
      </div>
    </div>

    <h3 style="margin-top:20px">å¤±è´¥è®°å½•ï¼ˆæ¥è‡ªåç«¯ï¼‰</h3>
    <div style="margin-bottom:12px">
      <button class="btn" style="background:#ff9800;" @click="triggerRetrain">è§¦å‘ Retrain</button>
      <span class="small" style="margin-left:8px">åŸºäºå½“å‰æ ‡æ³¨æ•°æ®é‡æ–°è®­ç»ƒè§„åˆ™</span>
    </div>
    <div v-if="failures.length===0"><em>æ— </em></div>
    <div v-for="f in failures" :key="f.doc_id" class="doc">
      <strong>{{f.doc_id}}</strong>
      <div class="small">{{f.raw_text}}</div>
      <div class="small">åŸå› : {{f.reason}}</div>
      <div style="margin-top:8px">
        <button @click="openAnnotate(f)" class="btn">äººå·¥æ ‡æ³¨</button>
      </div>
    </div>

    <!-- ç®€å•çš„æ³¨é‡Šå¼¹çª— -->
    <div v-if="annotateModal" style="position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center">
      <div style="background:#fff;padding:20px;border-radius:8px;width:600px">
        <h4>æ·»åŠ äººå·¥æ ‡æ³¨</h4>
        <div>Doc ID: <input v-model="anno.doc_id" /></div>
        <div style="margin-top:8px">Raw Text:<br/><textarea v-model="anno.raw_text" style="height:80px"></textarea></div>
        <div style="margin-top:8px">Param Name: <input v-model="anno.param_name" /></div>
        <div style="margin-top:8px">Param Value: <input v-model="anno.param_value" /></div>
        <div style="margin-top:12px">
          <button class="btn" @click="submitAnnotation">æäº¤</button>
          <button class="btn" style="background:#999;margin-left:8px" @click="annotateModal=false">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

  </div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp, ref, reactive } = Vue;
createApp({
  setup(){
    const docId = ref('DOC1')
    const rawText = ref('æ£€æŸ¥æŠ¥å‘Šï¼šå·¦å®¤å£å¼¥æ¼«æ€§è¿åŠ¨å‡å¼± å·¦å®¤æ”¶ç¼©åŠŸèƒ½é™ä½ï¼ˆLVEF: 40%ï¼‰ å¤‡æ³¨: æ— å…¶ä»–å¼‚å¸¸')
    const results = ref([])
    const failures = ref([])
    const annotateModal = ref(false)
    const anno = reactive({doc_id:'', raw_text:'', param_name:'', param_value:''})

    async function processSingle(){
      const payload = {documents:[{doc_id:docId.value, raw_text:rawText.value}]}
      const res = await fetch('/api/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
      const j = await res.json()
      results.value = j.results
      // æ›´æ–° failures
      await loadFailures()
    }

    async function batchProcess(){
      // ç®€å•ç¤ºä¾‹æ‰¹é‡
      const docs = [
        {doc_id:'A', raw_text:'æ£€æŸ¥æŠ¥å‘Šï¼šå·¦å®¤å£å¼¥æ¼«æ€§è¿åŠ¨å‡å¼± å·¦å®¤æ”¶ç¼©åŠŸèƒ½é™ä½ï¼ˆLVEF: 40%ï¼‰ å¤‡æ³¨: æ— å…¶ä»–å¼‚å¸¸'},
        {doc_id:'B', raw_text:'è¶…å£°æ˜¾ç¤ºï¼šLVEF=55%ï¼Œèˆ’å¼ åŠŸèƒ½æ­£å¸¸ã€‚å·¦å¿ƒæˆ¿å¢å¤§ã€‚'},
        {doc_id:'C', raw_text:'å¿ƒç”µå›¾ï¼šçª¦æ€§å¿ƒå¾‹ï¼ŒSTæ®µè½»å¾®æŠ¬é«˜ã€‚è¯„ä¼°ï¼šå¿ƒè‚Œç¼ºè¡€å¯èƒ½ã€‚'},
        {doc_id:'D', raw_text:'ç—…å†å°ç»“ï¼šæ‚£è€…ä¸»è¯‰èƒ¸é—·ï¼Œå¿ƒå®¤è‚Œæ”¶ç¼©åŠ›å‡å¼±ï¼Œå°„è¡€åˆ†æ•°å¤§çº¦ä¸º 38% å·¦å³ã€‚'},
        {doc_id:'E', raw_text:'å¤‡æ³¨ï¼šLVEFå¤§çº¦å››æˆã€‚'}
      ]
      const res = await fetch('/api/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({documents:docs})})
      const j = await res.json()
      results.value = j.results
      await loadFailures()
    }

    async function loadFailures(){
      const res = await fetch('/api/failures')
      const j = await res.json()
      failures.value = j.failures || []
    }

    function markFailure(r){
      // é¢„å¡«æ³¨é‡Š modal
      anno.doc_id = r.doc_id
      anno.raw_text = r.raw_text
      anno.param_name = ''
      anno.param_value = ''
      annotateModal.value = true
    }

    function openAnnotate(f){
      anno.doc_id = f.doc_id
      anno.raw_text = f.raw_text
      annotateModal.value = true
    }

    async function submitAnnotation(){
      const form = new FormData();
      form.append('doc_id', anno.doc_id)
      form.append('raw_text', anno.raw_text)
      form.append('param_name', anno.param_name)
      form.append('param_value', anno.param_value)
      await fetch('/api/annotations/add',{method:'POST', body: form})
      annotateModal.value = false
      
      // æäº¤æ ‡æ³¨åè‡ªåŠ¨è§¦å‘ retrain
      await triggerRetrain()
    }

    async function triggerRetrain(){
      try {
        const response = await fetch('/api/retrain', {method: 'POST'})
        const result = await response.json()
        
        if (result.status === 'applied') {
          alert(`âœ… è§„åˆ™é‡è®­ç»ƒæˆåŠŸï¼\n\nåº”ç”¨äº† ${result.rules_count} æ¡æ–°è§„åˆ™\nåŸºäº ${result.annotations_count} æ¡æ ‡æ³¨æ•°æ®\n\nè§„åˆ™åº“å·²æ›´æ–°ï¼Œå¯ä»¥é‡æ–°å¤„ç†æ–‡æ¡£æµ‹è¯•æ•ˆæœã€‚`)
        } else if (result.status === 'no_annotations') {
          alert('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ ‡æ³¨æ•°æ®\n\nè¯·å…ˆå¯¹å¤±è´¥çš„æ–‡æ¡£è¿›è¡Œäººå·¥æ ‡æ³¨ï¼Œç„¶åå†æ¬¡è§¦å‘é‡è®­ç»ƒã€‚')
        } else if (result.status === 'no_rules_generated') {
          alert(`â„¹ï¸ DeepSeek æœªç”Ÿæˆæ–°è§„åˆ™\n\nåŸºäº ${result.annotations_count} æ¡æ ‡æ³¨æ•°æ®ï¼ŒDeepSeek æœªç”Ÿæˆæ–°è§„åˆ™\nè§„åˆ™åº“ä¿æŒä¸å˜ã€‚`)
        } else if (result.status === 'deepseek_disabled') {
          alert('ğŸ”§ DeepSeek åŠŸèƒ½æœªå¯ç”¨\n\nå¦‚éœ€ä½¿ç”¨è‡ªåŠ¨è§„åˆ™ç”ŸæˆåŠŸèƒ½ï¼Œè¯·å¯ç”¨ DeepSeek API é…ç½®ã€‚')
        } else {
          alert(`æœªçŸ¥çŠ¶æ€: ${result.status}\n\n${result.message || 'è¯·æ£€æŸ¥åç«¯æ—¥å¿—'}`)
        }
      } catch (error) {
        alert('âŒ é‡è®­ç»ƒè¯·æ±‚å¤±è´¥ï¼š' + error.message)
      }
    }

    async function downloadStructured(){
      const res = await fetch('/api/structured')
      if (res.ok){
        const blob = await res.blob()
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url; a.download = 'structured.json'; document.body.appendChild(a); a.click(); a.remove();
      } else {
        alert('å°šæœªç”Ÿæˆ structured.json')
      }
    }

    // init
    loadFailures()

    return {docId, rawText, processSingle, batchProcess, results, failures, markFailure, annotateModal, anno, openAnnotate, submitAnnotation, downloadStructured}
  }
}).mount('#app')
</script>
</body>
</html>
