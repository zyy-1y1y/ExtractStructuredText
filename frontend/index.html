<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文本结构化提取工具</title>
  <style>
      body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      #app { 
        max-width: 1200px; 
        margin: 0 auto; 
        padding: 20px;
      }
      h2 { 
        color: #333; 
        margin: 0 0 30px 0; 
        font-size: 2.5em;
        font-weight: 300;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
      }
      .doc, div[style*="background:"] { 
        background: rgba(255,255,255,0.95); 
        backdrop-filter: blur(10px);
        padding: 25px; 
        margin-bottom: 25px; 
        border-radius: 15px; 
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .doc:hover, div[style*="background:"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      }
      .btn { 
        padding: 12px 20px; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        margin: 5px; 
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #2b8cff;
        color: #fff;
        text-decoration: none;
      }
      .btn:hover { 
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      .btn:disabled { 
        opacity: 0.6; 
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .modal { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.5); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        z-index: 1000; 
        backdrop-filter: blur(5px);
      }
      .modal-content { 
        background: white; 
        padding: 30px; 
        border-radius: 15px; 
        width: 500px; 
        max-width: 90%; 
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s ease;
      }
      @keyframes modalSlideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .form-group { 
        margin-bottom: 20px; 
      }
      label { 
        display: block; 
        margin-bottom: 8px; 
        font-weight: 600;
        color: #333;
      }
      input, textarea { 
        width: 100%; 
        padding: 12px; 
        border: 2px solid #e1e5e9; 
        border-radius: 8px; 
        box-sizing: border-box; 
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      input:focus, textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      textarea{width:100%;height:120px; min-height: 120px; resize: vertical; }
      .small{font-size:0.85em;color:#666; line-height: 1.4;}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #eee;padding:8px}
      .file-list { 
        margin-top: 15px; 
      }
      .file-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 12px; 
        background: #f8f9fa; 
        margin-bottom: 8px; 
        border-radius: 8px; 
        border-left: 4px solid #667eea;
        transition: background-color 0.3s ease;
      }
      .file-item:hover {
        background: #e9ecef;
      }
      .status-processing { 
        color: #ff9800; 
        font-weight: 600; 
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }
      .status-success { 
        color: #4caf50; 
        font-weight: 600; 
      }
      .status-error { 
        color: #f44336; 
        font-weight: 600; 
      }
      .rule-item {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #28a745;
      }
      .history-record {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        transition: transform 0.2s ease;
      }
      .history-record:hover {
        transform: translateX(5px);
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }
      
      /* 新增：处理结果提示样式 */
      .success-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        z-index: 1001;
        animation: slideInRight 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .error-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #f44336, #d32f2f);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
        z-index: 1001;
        animation: slideInRight 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
      
      /* 进度条样式 */
      .progress-container {
        width: 100%;
        background: #f0f0f0;
        border-radius: 10px;
        margin: 15px 0;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      }
      
      .progress-bar {
        height: 12px;
        background: linear-gradient(90deg, #4CAF50, #45a049, #2E7D32);
        border-radius: 10px;
        transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        width: 0%;
        position: relative;
        overflow: hidden;
      }
      
      .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shimmer 2s infinite;
      }
      
      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }
      
      .progress-text {
        font-size: 0.95em;
        color: #333;
        margin-top: 8px;
        text-align: center;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .progress-status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        font-size: 0.9em;
        color: #666;
      }
      
      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4CAF50;
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .processing-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin: 15px 0;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #4CAF50;
      }
      
      .stat-item {
        text-align: center;
        padding: 8px;
      }
      
      .stat-value {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
      }
      
      .stat-label {
        font-size: 0.8em;
        color: #666;
        margin-top: 2px;
      }
      
      /* 结果统计卡片样式 */
      .result-summary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 25px;
        border-radius: 15px;
        margin: 20px 0;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }
      
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      
      .summary-item {
        text-align: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        transition: transform 0.2s ease, background 0.2s ease;
      }
      
      .summary-item:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.3);
      }
      
      .summary-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .summary-label {
        font-size: 0.85em;
        opacity: 0.9;
      }
      
      /* 可视化图表样式 */
      .visualization-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      
      .chart-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        backdrop-filter: blur(10px);
      }
      
      .chart-title {
        font-size: 1.1em;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
      }
      
      .chart-bar {
        height: 20px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        margin: 5px 0;
        overflow: hidden;
        position: relative;
      }
      
      .chart-fill {
        height: 100%;
        background: linear-gradient(90deg, #4CAF50, #8BC34A);
        border-radius: 10px;
        transition: width 0.5s ease;
      }
      
      .chart-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.8em;
        margin-bottom: 5px;
      }
      
      /* 参数分布样式 */
      .param-distribution {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      
      .param-tag {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      
      /* 性能指标样式 */
      .performance-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      
      .metric-item {
        text-align: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
      }
      
      .metric-value {
        font-size: 1.4em;
        font-weight: bold;
        margin-bottom: 5px;
      }
      
      .metric-label {
        font-size: 0.8em;
        opacity: 0.9;
      }
    </style>
</head>
<body>
  <div id="app">
    <div style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); text-align: center;">
      <h2>智能文本提取系统</h2>
      <p style="color: #666; font-size: 1.1em; margin: 10px 0 0 0;">基于规则和AI的医疗文档结构化信息提取平台</p>
    </div>

    <!-- 提示消息组件 -->
    <div v-if="showToast" :class="toastType === 'success' ? 'success-toast' : toastType === 'error' ? 'error-toast' : 'success-toast'">
      <span v-if="toastType === 'success'" style="font-size:1.2em;">✅</span>
      <span v-if="toastType === 'error'" style="font-size:1.2em;">❌</span>
      <span v-if="toastType === 'warning'" style="font-size:1.2em;">⚠️</span>
      <span>{{ toastMessage }}</span>
    </div>

    <!-- 文档上传功能 -->
    <div style="margin-bottom:20px; padding:25px; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin-top:0; color:#333;">📁 文档上传与处理</h3>
      <p class="small">上传文档进行结构化信息提取，支持多种文件格式</p>
      
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
        <input type="file" id="fileInput" multiple accept=".txt,.csv,.json" style="display:none" @change="handleFileUpload">
        <button class="btn" style="background:#2196F3" @click="triggerFileInput">
          📄 选择文件
        </button>
        <span class="small">支持 .txt, .csv, .json 格式（可多选）</span>
      </div>
      
      <!-- 文件列表和进度显示 -->
      <div v-if="uploadedFiles.length > 0" style="margin-top:15px;">
        <div style="margin-bottom:15px;">
          <h4 style="margin:0 0 10px 0; color:#333;">📋 已选择文件 ({{ uploadedFiles.length }} 个)</h4>
          <div v-for="(file, index) in uploadedFiles" :key="index" class="file-item">
            <div style="display:flex; align-items:center; gap:10px; flex:1;">
              <span style="font-weight:600;">{{ file.name }}</span>
              <span class="small">({{ (file.size/1024).toFixed(1) }}KB)</span>
            </div>
            <button @click="removeFile(index)" style="background:#ff4444; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:12px;">移除</button>
          </div>
        </div>
        
        <!-- 进度条和状态显示 -->
        <div v-if="processingProgress.show" style="margin-bottom:20px;">
          <!-- 状态指示器 -->
          <div class="progress-status">
            <div class="status-indicator"></div>
            <span>正在处理中...</span>
          </div>
          
          <!-- 实时统计信息 -->
          <div v-if="processingProgress.value > 0 && processingProgress.value < 100" class="processing-stats">
            <div class="stat-item">
              <div class="stat-value">{{ uploadedFiles.length }}</div>
              <div class="stat-label">待处理文档</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ Math.round(processingProgress.value) }}%</div>
              <div class="stat-label">处理进度</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ processingProgress.estimatedTime || '--' }}</div>
              <div class="stat-label">预计剩余</div>
            </div>
          </div>
          
          <!-- 进度条 -->
          <div class="progress-container">
            <div class="progress-bar" :style="{ width: processingProgress.value + '%' }"></div>
          </div>
          
          <!-- 进度文本 -->
          <div class="progress-text">
            <span v-if="processingProgress.value < 100">🔄</span>
            <span v-if="processingProgress.value === 100">✅</span>
            {{ processingProgress.text }}
          </div>
        </div>
        
        <button class="btn" style="background:#4CAF50;" @click="processUploadedFiles" :disabled="processingProgress.show">
          🚀 开始处理文档
        </button>
      </div>
    </div>
    
    <!-- 处理结果统计 -->
    <div v-if="resultSummary.show" class="result-summary">
      <h3 style="margin:0 0 10px 0; color:white;">🎉 处理完成！</h3>
      <p style="margin:0; opacity:0.9;">文档处理已完成，以下是处理结果统计：</p>
      
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-number">{{ resultSummary.totalDocuments }}</div>
          <div class="summary-label">处理文档</div>
        </div>
        <div class="summary-item">
          <div class="summary-number">{{ resultSummary.extractedParams }}</div>
          <div class="summary-label">提取参数</div>
        </div>
        <div class="summary-item">
          <div class="summary-number">{{ resultSummary.totalLines }}</div>
          <div class="summary-label">处理行数</div>
        </div>
        <div class="summary-item">
          <div class="summary-number">{{ resultSummary.successLines }}</div>
          <div class="summary-label">成功行数</div>
        </div>
      </div>
      
      <!-- 可视化分析区域 -->
      <div v-if="showVisualization" class="visualization-grid">
        <!-- 处理成功率图表 -->
        <div class="chart-container">
          <div class="chart-title">📈 处理成功率</div>
          <div class="chart-label">
            <span>成功率</span>
            <span>{{ resultSummary.successRate }}%</span>
          </div>
          <div class="chart-bar">
            <div class="chart-fill" :style="{ width: resultSummary.successRate + '%' }"></div>
          </div>
          <div style="font-size:0.8em; text-align:center; margin-top:5px;">
            {{ resultSummary.successLines }} / {{ resultSummary.totalLines }} 行
          </div>
        </div>
        
        <!-- 参数分布图表 -->
        <div class="chart-container">
          <div class="chart-title">🔍 参数分布</div>
          <div v-if="resultSummary.paramDistribution && resultSummary.paramDistribution.length > 0">
            <div v-for="param in resultSummary.paramDistribution.slice(0, 5)" :key="param.name" class="chart-label">
              <span>{{ param.name }}</span>
              <span>{{ param.count }}</span>
            </div>
            <div v-if="resultSummary.paramDistribution.length > 5" style="font-size:0.8em; text-align:center; margin-top:5px;">
              还有 {{ resultSummary.paramDistribution.length - 5 }} 个参数
            </div>
          </div>
          <div v-else style="text-align:center; opacity:0.7; font-size:0.9em;">
            暂无参数数据
          </div>
        </div>
        
        <!-- 性能指标 -->
        <div class="chart-container">
          <div class="chart-title">⚡ 性能指标</div>
          <div class="performance-metrics">
            <div class="metric-item">
              <div class="metric-value">{{ resultSummary.processingTime }}s</div>
              <div class="metric-label">处理时间</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">{{ resultSummary.documentsPerSecond }}</div>
              <div class="metric-label">文档/秒</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">{{ resultSummary.paramsPerSecond }}</div>
              <div class="metric-label">参数/秒</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 参数标签云 -->
      <div v-if="resultSummary.paramDistribution && resultSummary.paramDistribution.length > 0" style="margin-top:20px;">
        <div style="font-size:1.1em; font-weight:bold; margin-bottom:10px;">🏷️ 提取的参数类型</div>
        <div class="param-distribution">
          <span v-for="param in resultSummary.paramDistribution" :key="param.name" class="param-tag">
            {{ param.name }} ({{ param.count }})
          </span>
        </div>
      </div>
      
      <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3);" @click="scrollToResults">
          📊 查看详细结果
        </button>
        <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3);" @click="downloadStructured">
          📥 下载JSON结果
        </button>
        <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3);" @click="showVisualization = !showVisualization">
          📈 {{ showVisualization ? '隐藏' : '显示' }}可视化
        </button>
      </div>
    </div>

    <!-- CSV标注文件上传功能 -->
    <div style="margin-bottom:20px; padding:15px; background:#f8f5e8; border-radius:8px;">
      <h3>📊 CSV标注文件上传</h3>
      <p class="small">上传包含人工标注的CSV文件，用于规则重训练</p>
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="file" id="csvInput" accept=".csv" style="display:none" @change="handleCsvUpload">
        <button class="btn" style="background:#FF9800" @click="triggerCsvInput">
          📊 选择CSV文件
        </button>
        <span class="small">支持标准CSV格式，包含 doc_id, raw_text, param_name, param_value 列</span>
      </div>
      <div v-if="csvFile" style="margin-top:10px;">
        <div style="display:flex; align-items:center;">
          <span style="flex:1;">{{ csvFile.name }} ({{ (csvFile.size/1024).toFixed(1) }}KB)</span>
          <button @click="removeCsvFile" style="background:#ff4444; color:white; border:none; padding:2px 8px; border-radius:3px; cursor:pointer;">×</button>
        </div>
        <button class="btn" style="background:#4CAF50; margin-top:8px;" @click="uploadCsvAnnotations">
          📤 上传标注文件
        </button>
        <div v-if="csvUploadStatus" style="margin-top:8px; padding:8px; background:#e8f5e8; border-radius:4px; font-size:0.9em;">
          {{ csvUploadStatus }}
        </div>
      </div>
    </div>

    <!-- 规则管理功能 -->
    <div style="margin-bottom:20px; padding:25px; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin-top:0; color:#333;">⚙️ 规则管理</h3>
      <p class="small">管理文本抽取规则，支持查看、编辑、添加和删除</p>
      
      <div style="margin-bottom:20px;">
        <button class="btn" style="background:#4CAF50" @click="loadRules">🔄 刷新规则</button>
        <button class="btn" style="background:#2196F3; margin-left:8px" @click="showAddRuleModal = true">➕ 添加规则</button>
      </div>
      
      <div v-if="rules.length > 0">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
          <div v-for="(rule, index) in rules" :key="index" class="rule-item">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
              <strong style="color:#333; font-size:1.1em;">{{ rule.name }}</strong>
              <div style="display:flex; gap:5px;">
                <button class="btn" style="background:#FF9800; padding:6px 12px; font-size:0.8em;" @click="editRule(index)" title="编辑规则">✏️</button>
                <button class="btn" style="background:#f44336; padding:6px 12px; font-size:0.8em;" @click="deleteRule(index)" title="删除规则">🗑️</button>
              </div>
            </div>
            <div style="font-size:0.9em; color:#555;">
              <div style="margin-bottom:8px;">
                <strong style="color:#333;">🔑 关键词:</strong>
                <div style="display:flex; flex-wrap:wrap; gap:4px; margin-top:4px;">
                  <span v-for="(keyword, kIndex) in rule.keywords" :key="kIndex" style="background:#e3f2fd; color:#1976d2; padding:2px 8px; border-radius:12px; font-size:0.85em;">
                    {{ keyword }}
                  </span>
                </div>
              </div>
              <div>
                <strong style="color:#333;">🔍 正则表达式:</strong>
                <div style="background:#f5f5f5; padding:8px; border-radius:6px; margin-top:4px; font-family: monospace; font-size:0.85em; word-break:break-all;">
                  {{ rule.regex || '无' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-else style="text-align:center; padding:40px; color:#666;">
        <div style="font-size:3em; margin-bottom:10px;">⚙️</div>
        <p style="margin:0;">暂无规则</p>
        <p class="small">点击"添加规则"按钮来创建新的抽取规则</p>
      </div>
    </div>

    <!-- 规则编辑/添加模态框 -->
    <div v-if="showAddRuleModal || showEditRuleModal" class="modal">
      <div class="modal-content">
        <h3 style="margin-top:0; color:#333; border-bottom:2px solid #f0f0f0; padding-bottom:15px;">
          {{ showEditRuleModal ? '✏️ 编辑规则' : '➕ 添加规则' }}
        </h3>
        
        <div class="form-group">
          <label>📝 规则名称:</label>
          <input type="text" v-model="currentRule.name" placeholder="请输入规则名称（如：LVEF提取规则）">
        </div>
        
        <div class="form-group">
          <label>🔑 关键词 (每行一个):</label>
          <textarea v-model="currentRule.keywordsText" placeholder="请输入关键词，每行一个&#10;例如：&#10;LVEF&#10;射血分数&#10;左室射血分数" style="min-height:100px;"></textarea>
          <p class="small">每个关键词单独一行，系统会自动识别包含这些关键词的文本</p>
        </div>
        
        <div class="form-group">
          <label>🔍 正则表达式:</label>
          <input type="text" v-model="currentRule.regex" placeholder="请输入正则表达式（如：\\d+%?）">
          <p class="small">用于精确匹配和提取数值，如：\\d+%? 匹配数字和百分比</p>
        </div>
        
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:30px; padding-top:20px; border-top:1px solid #f0f0f0;">
          <button class="btn" style="background:#666;" @click="closeRuleModal">取消</button>
          <button class="btn" style="background:#4CAF50;" @click="saveRule">{{ showEditRuleModal ? '更新规则' : '添加规则' }}</button>
        </div>
      </div>
    </div>

    <!-- 处理历史记录功能 -->
    <div style="margin-bottom:20px; padding:25px; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin-top:0; color:#333;">📊 处理历史记录</h3>
      <p class="small">查看之前的处理结果和统计信息</p>
      
      <div style="margin-bottom:20px;">
        <button class="btn" style="background:#2196F3" @click="loadHistory">🔄 刷新历史</button>
        <button class="btn" style="background:#FF9800; margin-left:8px" @click="clearHistory">🗑️ 清空历史</button>
      </div>
      
      <div v-if="historyRecords.length > 0">
        <!-- 统计卡片 -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">{{ historyRecords.length }}</div>
            <div class="stat-label">总处理次数</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ successCount }}</div>
            <div class="stat-label">成功处理</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ failureCount }}</div>
            <div class="stat-label">失败处理</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ historyRecords.reduce((total, r) => total + r.extractedParams, 0) }}</div>
            <div class="stat-label">总提取参数</div>
          </div>
        </div>
        
        <!-- 历史记录列表 -->
        <div v-for="(record, index) in historyRecords" :key="index" class="history-record">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <strong style="color:#333;">{{ record.timestamp }}</strong>
            <span :style="{color: record.status === 'success' ? '#4CAF50' : '#ff4444', background: record.status === 'success' ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 68, 68, 0.1)', padding: '4px 12px', borderRadius: '20px', fontSize: '0.9em'}">
              {{ record.status === 'success' ? '✅ 成功' : '❌ 失败' }}
            </span>
          </div>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size:0.9em;">
            <div><strong>📄 文档数量:</strong> {{ record.documentCount }}</div>
            <div><strong>🔍 提取参数:</strong> {{ record.extractedParams }}</div>
            <div v-if="record.error" style="grid-column: 1 / -1; color:#ff4444; background:rgba(255,68,68,0.1); padding:8px; border-radius:6px;">
              <strong>错误信息:</strong> {{ record.error }}
            </div>
          </div>
        </div>
      </div>
      <div v-else style="text-align:center; padding:40px; color:#666;">
        <div style="font-size:3em; margin-bottom:10px;">📋</div>
        <p style="margin:0;">暂无处理历史记录</p>
        <p class="small">开始处理文档后，这里会显示处理历史</p>
      </div>
    </div>

    <!-- 文本输入功能 -->
    <div style="margin-bottom:20px; padding:15px; background:#f5f5f5; border-radius:8px;">
      <h3>📝 文本输入</h3>
      <div>
        <label>Doc ID: <input v-model="docId" /></label>
      </div>
      <div style="margin-top:8px">
        <textarea v-model="rawText" placeholder="在此粘贴检查报告或病历原文..."></textarea>
      </div>
      <div style="margin-top:8px">
        <button class="btn" @click="processSingle">处理当前文本</button>
        <button class="btn" style="background:#4caf50;margin-left:8px" @click="batchProcess">处理示例批量</button>
        <button class="btn" style="background:#777;margin-left:8px" @click="downloadStructured">下载 JSON</button>
      </div>
    </div>

    <h3 style="margin-top:20px">处理结果</h3>
    <div v-if="results.length===0"><em>暂无结果</em></div>
    <div v-for="r in results" :key="r.doc_id" class="doc">
      <strong>{{r.doc_id}}</strong>
      <div class="small">{{r.raw_text}}</div>
      
      <!-- 逐行处理结果 -->
      <div style="margin-top:12px; border:1px solid #e0e0e0; border-radius:4px; padding:8px; background:#f9f9f9;">
        <h4 style="margin:0 0 8px 0; font-size:14px;">📝 逐行处理结果</h4>
        <div v-for="line in r.line_results" :key="line.line_number" style="margin-bottom:8px; padding:6px; border-left:3px solid #4caf50; background:white;">
          <div style="font-size:12px; color:#666;">第{{line.line_number}}行:</div>
          <div style="font-size:13px; margin:4px 0;">{{line.line_text}}</div>
          <div v-if="line.extracted && line.extracted.length > 0" style="font-size:12px;">
            <span style="color:#4caf50;">✅ 提取到参数:</span>
            <span v-for="e in line.extracted" :key="e.param_name" style="margin-left:8px; background:#e8f5e8; padding:2px 6px; border-radius:3px;">
              {{e.param_name}}: {{e.param_value}}
            </span>
          </div>
          <div v-else style="font-size:12px; color:#ff9800;">
            ⚠️ 未提取到参数
          </div>
        </div>
      </div>
      
      <!-- 汇总结果 -->
      <div style="margin-top:12px;">
        <h4 style="margin:0 0 8px 0; font-size:14px;">📊 汇总结果</h4>
        <table>
          <thead><tr><th>参数名</th><th>值</th><th>来源行号</th></tr></thead>
          <tbody>
            <tr v-for="e in r.extracted" :key="e.param_name">
              <td>{{e.param_name}}</td>
              <td>{{e.param_value}}</td>
              <td>
                <span v-for="line in r.line_results" :key="line.line_number">
                  <span v-if="line.extracted && line.extracted.some(ext => ext.param_name === e.param_name && ext.param_value === e.param_value)">
                    {{line.line_number}}
                  </span>
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div style="margin-top:8px">
        <span class="small">状态: {{r.status}}</span>
        <span class="small" style="margin-left:12px;">总行数: {{r.line_results ? r.line_results.length : 0}}</span>
        <span class="small" style="margin-left:12px;">成功行数: {{r.line_results ? r.line_results.filter(l => l.extracted && l.extracted.length > 0).length : 0}}</span>
        <button style="margin-left:8px" @click="markFailure(r)">标注为失败并添加人工注释</button>
      </div>
    </div>

    <h3 style="margin-top:20px">失败记录（来自后端）</h3>
    <div style="margin-bottom:12px">
      <button class="btn" style="background:#ff9800;" @click="triggerRetrain">触发 Retrain</button>
      <span class="small" style="margin-left:8px">基于当前标注数据重新训练规则</span>
    </div>
    <div v-if="failures.length===0"><em>无</em></div>
    <div v-for="f in failures" :key="f.doc_id" class="doc">
      <strong>{{f.doc_id}}</strong>
      <div class="small">{{f.raw_text}}</div>
      <div class="small">原因: {{f.reason}}</div>
      <div style="margin-top:8px">
        <button @click="openAnnotate(f)" class="btn">人工标注</button>
      </div>
    </div>

    <!-- 支持多参数的注释弹窗 -->
    <div v-if="annotateModal" style="position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center">
      <div style="background:#fff;padding:20px;border-radius:8px;width:700px;max-height:80vh;overflow-y:auto">
        <h4>添加人工标注</h4>
        <div>Doc ID: <input v-model="anno.doc_id" readonly style="background:#f5f5f5" /></div>
        <div style="margin-top:8px">原始文本:<br/><textarea v-model="anno.raw_text" style="height:80px;width:100%" readonly></textarea></div>
        
        <div style="margin-top:16px;border-top:1px solid #eee;padding-top:16px">
          <h5>参数标注</h5>
          <div v-for="(param, index) in anno.params" :key="index" style="margin-bottom:12px;padding:12px;border:1px solid #ddd;border-radius:4px">
            <div style="display:flex;gap:8px;align-items:center">
              <div style="flex:1">
                <div>参数名称:</div>
                <input v-model="param.param_name" placeholder="例如：LVEF" style="width:100%" />
              </div>
              <div style="flex:1">
                <div>参数值:</div>
                <input v-model="param.param_value" placeholder="例如：40%" style="width:100%" />
              </div>
              <div style="margin-top:20px">
                <button @click="removeParam(index)" style="background:#ff4444;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer">删除</button>
              </div>
            </div>
          </div>
          
          <button @click="addParam()" style="background:#4CAF50;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-bottom:16px">+ 添加参数</button>
        </div>
        
        <div style="margin-top:16px;border-top:1px solid #eee;padding-top:16px">
          <button class="btn" @click="submitAnnotation">提交标注</button>
          <button class="btn" style="background:#999;margin-left:8px" @click="annotateModal=false">取消</button>
        </div>
      </div>
    </div>

  </div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const { createApp, ref, reactive } = Vue;
createApp({
  setup(){
    const docId = ref('DOC1')
    const rawText = ref('检查报告：左室壁弥漫性运动减弱 左室收缩功能降低（LVEF: 40%） 备注: 无其他异常')
    const results = ref([])
    const failures = ref([])
    const annotateModal = ref(false)
    const anno = reactive({doc_id:'', raw_text:'', params: [{param_name: '', param_value: ''}]})
    const uploadedFiles = ref([])
    const processingStatus = ref('')
    const csvFile = ref(null)
    const csvUploadStatus = ref('')
    const rules = ref([])
    const showAddRuleModal = ref(false)
    const showEditRuleModal = ref(false)
    const currentRule = reactive({
      name: '',
      keywordsText: '',
      regex: '',
      index: -1
    })
    const historyRecords = ref([])
    
    // 新增响应式数据：处理进度和结果统计
    const processingProgress = reactive({
      show: false,
      value: 0,
      text: '正在处理...',
      estimatedTime: '--',
      startTime: null
    })
    
    const resultSummary = reactive({
      show: false,
      totalDocuments: 0,
      totalLines: 0,
      successLines: 0,
      extractedParams: 0,
      processingTime: 0,
      successRate: 0,
      documentsPerSecond: '0.0',
      paramsPerSecond: '0.0',
      paramDistribution: []
    })
    
    const showVisualization = ref(true)
    
    const toastMessage = ref('')
    const toastType = ref('success') // success, error, warning
    const showToast = ref(false)

    // 新增函数：显示提示消息
    function showToastMessage(message, type = 'success') {
      toastMessage.value = message
      toastType.value = type
      showToast.value = true
      
      // 3秒后自动隐藏
      setTimeout(() => {
        showToast.value = false
      }, 3000)
    }
    
    // 新增函数：更新处理进度
    function updateProgress(value, text) {
      processingProgress.value = value
      processingProgress.text = text
      processingProgress.show = true
      
      // 计算预计剩余时间
      if (value > 0 && value < 100) {
        if (!processingProgress.startTime) {
          processingProgress.startTime = Date.now()
        }
        
        const elapsedTime = Date.now() - processingProgress.startTime
        const estimatedTotalTime = (elapsedTime / value) * 100
        const remainingTime = estimatedTotalTime - elapsedTime
        
        if (remainingTime > 0) {
          const minutes = Math.floor(remainingTime / 60000)
          const seconds = Math.floor((remainingTime % 60000) / 1000)
          
          if (minutes > 0) {
            processingProgress.estimatedTime = `${minutes}分${seconds}秒`
          } else {
            processingProgress.estimatedTime = `${seconds}秒`
          }
        }
      }
    }
    
    // 新增函数：显示结果统计
    function showResultSummary(results, processingTime) {
      const totalDocuments = results.length
      const totalLines = results.reduce((total, r) => total + (r.raw_text ? r.raw_text.split('\n').length : 0), 0)
      const successLines = results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)
      const extractedParams = results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)
      
      // 计算成功率
      const successRate = totalLines > 0 ? Math.round((successLines / totalLines) * 100) : 0
      
      // 计算性能指标
      const documentsPerSecond = parseFloat(processingTime) > 0 ? (totalDocuments / parseFloat(processingTime)).toFixed(1) : '0.0'
      const paramsPerSecond = parseFloat(processingTime) > 0 ? (extractedParams / parseFloat(processingTime)).toFixed(1) : '0.0'
      
      // 分析参数分布
      const paramDistribution = analyzeParamDistribution(results)
      
      resultSummary.totalDocuments = totalDocuments
      resultSummary.totalLines = totalLines
      resultSummary.successLines = successLines
      resultSummary.extractedParams = extractedParams
      resultSummary.processingTime = processingTime
      resultSummary.successRate = successRate
      resultSummary.documentsPerSecond = documentsPerSecond
      resultSummary.paramsPerSecond = paramsPerSecond
      resultSummary.paramDistribution = paramDistribution
      resultSummary.show = true
    }
    
    // 新增函数：分析参数分布
    function analyzeParamDistribution(results) {
      const paramCounts = {}
      
      results.forEach(result => {
        if (result.extracted && Array.isArray(result.extracted)) {
          result.extracted.forEach(param => {
            if (param.name) {
              paramCounts[param.name] = (paramCounts[param.name] || 0) + 1
            }
          })
        }
      })
      
      // 转换为数组并按数量排序
      return Object.entries(paramCounts)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count)
    }
    
    // 新增函数：滚动到结果区域
    function scrollToResults() {
      const resultsSection = document.querySelector('h3[style*="margin-top:20px"]')
      if (resultsSection) {
        resultsSection.scrollIntoView({ behavior: 'smooth' })
      }
    }
    
    // 文档上传相关函数
    function triggerFileInput() {
      const fileInput = document.getElementById('fileInput')
      if (fileInput) {
        fileInput.click()
      }
    }
    
    function triggerCsvInput() {
      const csvInput = document.getElementById('csvInput')
      if (csvInput) {
        csvInput.click()
      }
    }
    
    function handleFileUpload(event) {
      const files = Array.from(event.target.files)
      uploadedFiles.value = [...uploadedFiles.value, ...files]
      event.target.value = '' // 清空input以便再次选择相同文件
    }

    function removeFile(index) {
      uploadedFiles.value.splice(index, 1)
    }

    async function processUploadedFiles() {
      if (uploadedFiles.value.length === 0) {
        showToastMessage('请先选择要上传的文件', 'warning')
        return
      }

      const startTime = Date.now()
      
      // 重置进度状态
      processingProgress.startTime = Date.now()
      processingProgress.estimatedTime = '--'
      
      // 显示处理进度
      updateProgress(0, '正在准备处理文件...')
      processingStatus.value = '正在读取和处理上传的文件...'
      
      try {
        const documents = []
        
        // 读取文件内容并更新进度
        for (let i = 0; i < uploadedFiles.value.length; i++) {
          const file = uploadedFiles.value[i]
          updateProgress((i / uploadedFiles.value.length) * 40, `正在读取文件: ${file.name}...`)
          
          const content = await readFileContent(file)
          const docId = file.name.replace(/\.[^/.]+$/, '') // 使用文件名作为doc_id
          documents.push({ doc_id: docId, raw_text: content })
        }

        updateProgress(50, `正在处理 ${documents.length} 个文档...`)
        processingStatus.value = `正在处理 ${documents.length} 个文档...`
        
        const payload = { documents }
        const res = await fetch('/api/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`)
        }
        
        updateProgress(80, '正在解析处理结果...')
        const j = await res.json()
        
        // 调试信息：打印接收到的结果
        console.log('API响应结果:', j)
        console.log('处理结果数量:', j.results.length)
        
        // 确保结果正确显示 - 使用Vue的响应式更新
        results.value = [...j.results]
        
        // 强制触发Vue更新
        await new Promise(resolve => setTimeout(resolve, 0))
        
        const processingTime = ((Date.now() - startTime) / 1000).toFixed(2)
        const extractedParams = j.results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)
        
        updateProgress(100, '处理完成！')
        processingStatus.value = `处理完成！共处理 ${documents.length} 个文档，提取到 ${extractedParams} 个参数，耗时 ${processingTime} 秒`
        
        // 显示成功提示
        showToastMessage(`文件处理完成！成功处理 ${documents.length} 个文档，提取到 ${extractedParams} 个参数。`, 'success')
        
        // 显示结果统计
        showResultSummary(j.results, processingTime)
        
        // 清空已上传文件列表
        uploadedFiles.value = []
        
        // 更新 failures
        await loadFailures()
        
        // 添加历史记录
        addHistoryRecord(j.results, 'success')
        
        // 滚动到结果区域
        setTimeout(() => {
          const resultsSection = document.querySelector('h3[style*="margin-top:20px"]')
          if (resultsSection) {
            resultsSection.scrollIntoView({ behavior: 'smooth' })
          }
        }, 100)
        
        // 2秒后隐藏进度条
        setTimeout(() => {
          processingProgress.show = false
          processingProgress.value = 0
          processingProgress.startTime = null
          processingProgress.estimatedTime = '--'
        }, 2000)
        
      } catch (error) {
        processingProgress.show = false
        processingProgress.value = 0
        processingProgress.startTime = null
        processingProgress.estimatedTime = '--'
        processingStatus.value = '处理失败'
        showToastMessage(`文档处理失败：${error.message}`, 'error')
        console.error('文档处理错误:', error)
        // 添加失败历史记录
        addHistoryRecord([], 'failed', error.message)
      }
    }

    function readFileContent(file) {
      return new Promise((resolve, reject) => {
        // 尝试多种编码方式，优先使用自动检测
        const encodings = ['UTF-8', 'GBK', 'GB2312', 'BIG5', 'ISO-8859-1', 'UTF-16LE', 'UTF-16BE']
        
        const tryNextEncoding = (index) => {
          if (index >= encodings.length) {
            // 如果所有编码都失败，尝试使用TextDecoder进行智能解码
            const reader = new FileReader()
            reader.onload = (e) => {
              const arrayBuffer = e.target.result
              try {
                // 尝试使用UTF-8解码
                const decoder = new TextDecoder('utf-8')
                const content = decoder.decode(arrayBuffer)
                if (!containsGarbledText(content)) {
                  resolve(content)
                } else {
                  // 尝试GBK解码
                  try {
                    const gbkDecoder = new TextDecoder('gbk')
                    const gbkContent = gbkDecoder.decode(arrayBuffer)
                    resolve(gbkContent)
                  } catch (gbkError) {
                    reject(new Error('无法识别文件编码，请检查文件是否为有效的中文文本'))
                  }
                }
              } catch (error) {
                reject(new Error('文件解码失败：' + error.message))
              }
            }
            reader.onerror = () => reject(new Error('文件读取失败'))
            reader.readAsArrayBuffer(file)
            return
          }
          
          const encoding = encodings[index]
          const reader = new FileReader()
          
          reader.onload = (e) => {
            const content = e.target.result
            // 检查内容是否包含乱码
            if (!containsGarbledText(content)) {
              console.log(`成功使用编码 ${encoding} 读取文件`)
              resolve(content)
            } else {
              console.log(`编码 ${encoding} 检测到乱码，尝试下一个编码`)
              // 如果检测到乱码，尝试下一个编码
              tryNextEncoding(index + 1)
            }
          }
          
          reader.onerror = () => {
            console.log(`编码 ${encoding} 读取失败，尝试下一个编码`)
            // 当前编码读取失败，尝试下一个
            tryNextEncoding(index + 1)
          }
          
          // 使用指定的编码读取文件
          reader.readAsText(file, encoding)
        }
        
        // 开始尝试编码
        tryNextEncoding(0)
      })
    }
    
    // 检测文本是否包含乱码
    function containsGarbledText(text) {
      // 常见的中文乱码模式
      const garbledPatterns = [
        /[\uFFFD]/g, // Unicode替换字符
        /[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, // 控制字符
        /[À-ÿ]{2,}/g, // 连续的拉丁字母扩展字符（可能是GBK乱码）
        /[ÃÂÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿ]{2,}/g // 更多可能的乱码模式
      ]
      
      // 检查中文字符比例（如果文本很长但中文字符很少，可能是乱码）
      const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || []
      const totalChars = text.length
      const chineseRatio = chineseChars.length / totalChars
      
      // 如果文本长度超过100字符但中文比例低于5%，可能有问题
      if (totalChars > 100 && chineseRatio < 0.05) {
        return true
      }
      
      // 检查乱码模式
      for (const pattern of garbledPatterns) {
        if (pattern.test(text)) {
          return true
        }
      }
      
      // 检查是否包含用户提到的特定乱码模式
      if (text.includes('��鱨�棺���ұ��������˶�����')) {
        return true
      }
      
      return false
    }

    // CSV标注文件上传相关函数
    function handleCsvUpload(event) {
      const files = event.target.files
      if (files.length > 0) {
        csvFile.value = files[0]
      }
      event.target.value = '' // 清空input以便再次选择相同文件
    }

    function removeCsvFile() {
      csvFile.value = null
      csvUploadStatus.value = ''
    }

    async function uploadCsvAnnotations() {
      if (!csvFile.value) {
        alert('请先选择CSV文件')
        return
      }

      csvUploadStatus.value = '正在上传CSV标注文件...'
      
      try {
        const formData = new FormData()
        formData.append('file', csvFile.value)
        
        const res = await fetch('/api/annotations/upload', {
          method: 'POST',
          body: formData
        })
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`)
        }
        
        const result = await res.json()
        csvUploadStatus.value = 'CSV标注文件上传成功！'
        
        // 上传成功后自动触发重训练
        setTimeout(async () => {
          await triggerRetrain()
        }, 1000)
        
      } catch (error) {
        csvUploadStatus.value = 'CSV文件上传失败'
        alert('CSV标注文件上传失败：' + error.message)
        console.error('CSV上传错误:', error)
      }
    }

    // 规则管理相关函数
    async function loadRules() {
      try {
        // 这里需要添加后端API来获取规则
        // 暂时使用模拟数据
        const mockRules = [
          {
            name: 'LVEF提取规则',
            keywords: ['LVEF', '射血分数', '左室射血分数'],
            regex: 'LVEF[：:\\s]*([0-9]+)%'
          },
          {
            name: '左室收缩功能规则',
            keywords: ['左室收缩功能', '收缩功能', '心室收缩'],
            regex: '左室收缩功能[：:\\s]*(降低|减弱|正常|下降)'
          }
        ]
        rules.value = mockRules
      } catch (error) {
        console.error('加载规则失败:', error)
        alert('加载规则失败：' + error.message)
      }
    }

    function editRule(index) {
      const rule = rules.value[index]
      currentRule.name = rule.name
      currentRule.keywordsText = rule.keywords ? rule.keywords.join('\\n') : ''
      currentRule.regex = rule.regex || ''
      currentRule.index = index
      showEditRuleModal.value = true
    }

    function deleteRule(index) {
      if (confirm('确定要删除这条规则吗？')) {
        rules.value.splice(index, 1)
        // 这里需要添加后端API来保存规则变更
        alert('规则删除成功（前端演示）')
      }
    }

    function saveRule() {
      if (!currentRule.name.trim()) {
        alert('请输入规则名称')
        return
      }

      const keywords = currentRule.keywordsText
        .split('\\n')
        .map(k => k.trim())
        .filter(k => k.length > 0)

      const newRule = {
        name: currentRule.name.trim(),
        keywords: keywords,
        regex: currentRule.regex.trim()
      }

      if (showEditRuleModal.value && currentRule.index >= 0) {
        // 编辑现有规则
        rules.value[currentRule.index] = newRule
      } else {
        // 添加新规则
        rules.value.push(newRule)
      }

      // 这里需要添加后端API来保存规则
      alert('规则保存成功（前端演示）')
      closeRuleModal()
    }

    function closeRuleModal() {
      showAddRuleModal.value = false
      showEditRuleModal.value = false
      currentRule.name = ''
      currentRule.keywordsText = ''
      currentRule.regex = ''
      currentRule.index = -1
    }

    // 处理历史记录相关函数
    function loadHistory() {
      // 从localStorage加载历史记录
      try {
        const savedHistory = localStorage.getItem('extractionHistory')
        if (savedHistory) {
          historyRecords.value = JSON.parse(savedHistory)
        } else {
          historyRecords.value = []
        }
      } catch (error) {
        console.error('加载历史记录失败:', error)
        historyRecords.value = []
      }
    }

    function clearHistory() {
      if (confirm('确定要清空所有处理历史记录吗？此操作不可恢复。')) {
        historyRecords.value = []
        localStorage.removeItem('extractionHistory')
        alert('历史记录已清空')
      }
    }

    function addHistoryRecord(results, status = 'success', error = null) {
      const record = {
        timestamp: new Date().toLocaleString('zh-CN'),
        documentCount: results.length,
        extractedParams: results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0),
        status: status,
        error: error
      }
      
      historyRecords.value.unshift(record) // 添加到开头
      
      // 只保留最近50条记录
      if (historyRecords.value.length > 50) {
        historyRecords.value = historyRecords.value.slice(0, 50)
      }
      
      // 保存到localStorage
      try {
        localStorage.setItem('extractionHistory', JSON.stringify(historyRecords.value))
      } catch (error) {
        console.error('保存历史记录失败:', error)
      }
    }

    // 计算属性：成功次数
    const successCount = Vue.computed(() => {
      return historyRecords.value.filter(r => r.status === 'success').length
    })
    
    // 计算属性：失败次数
    const failureCount = Vue.computed(() => {
      return historyRecords.value.filter(r => r.status === 'failed').length
    })

    async function processSingle(){
      const startTime = Date.now()
      
      // 重置进度状态
      processingProgress.startTime = Date.now()
      processingProgress.estimatedTime = '--'
      
      try {
        updateProgress(30, '正在处理单个文档...')
        
        const payload = {documents:[{doc_id:docId.value, raw_text:rawText.value}]}
        const res = await fetch('/api/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`)
        }
        
        updateProgress(80, '正在解析处理结果...')
        const j = await res.json()
        results.value = j.results
        
        const processingTime = ((Date.now() - startTime) / 1000).toFixed(2)
        const extractedParams = j.results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)
        
        updateProgress(100, '处理完成！')
        showToastMessage(`单个文档处理完成！提取到 ${extractedParams} 个参数，耗时 ${processingTime} 秒`, 'success')
        showResultSummary(j.results, processingTime)
        
        // 更新 failures
        await loadFailures()
        // 添加历史记录
        addHistoryRecord(j.results, 'success')
        
        // 2秒后隐藏进度条
        setTimeout(() => {
          processingProgress.show = false
          processingProgress.value = 0
          processingProgress.startTime = null
          processingProgress.estimatedTime = '--'
        }, 2000)
        
      } catch (error) {
        processingProgress.show = false
        processingProgress.value = 0
        processingProgress.startTime = null
        processingProgress.estimatedTime = '--'
        showToastMessage(`文档处理失败：${error.message}`, 'error')
        console.error('处理失败:', error)
        addHistoryRecord([], 'failed', error.message)
      }
    }

    async function batchProcess(){
      const startTime = Date.now()
      
      // 重置进度状态
      processingProgress.startTime = Date.now()
      processingProgress.estimatedTime = '--'
      
      try {
        updateProgress(20, '正在准备批量处理数据...')
        
        // 简单示例批量
        const docs = [
          {doc_id:'A', raw_text:'检查报告：左室壁弥漫性运动减弱 左室收缩功能降低（LVEF: 40%） 备注: 无其他异常'},
          {doc_id:'B', raw_text:'超声显示：LVEF=55%，舒张功能正常。左心房增大。'},
          {doc_id:'C', raw_text:'心电图：窦性心律，ST段轻微抬高。评估：心肌缺血可能。'},
          {doc_id:'D', raw_text:'病历小结：患者主诉胸闷，心室肌收缩力减弱，射血分数大约为 38% 左右。'},
          {doc_id:'E', raw_text:'备注：LVEF大约四成。'}
        ]
        
        updateProgress(50, '正在处理批量文档...')
        const res = await fetch('/api/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({documents:docs})})
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`)
        }
        
        updateProgress(80, '正在解析处理结果...')
        const j = await res.json()
        results.value = j.results
        
        const processingTime = ((Date.now() - startTime) / 1000).toFixed(2)
        const extractedParams = j.results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)
        
        updateProgress(100, '批量处理完成！')
        showToastMessage(`批量处理完成！成功处理 ${docs.length} 个文档，提取到 ${extractedParams} 个参数，耗时 ${processingTime} 秒`, 'success')
        showResultSummary(j.results, processingTime)
        
        await loadFailures()
        // 添加历史记录
        addHistoryRecord(j.results, 'success')
        
        // 2秒后隐藏进度条
        setTimeout(() => {
          processingProgress.show = false
          processingProgress.value = 0
          processingProgress.startTime = null
          processingProgress.estimatedTime = '--'
        }, 2000)
        
      } catch (error) {
        processingProgress.show = false
        processingProgress.value = 0
        processingProgress.startTime = null
        processingProgress.estimatedTime = '--'
        showToastMessage(`批量处理失败：${error.message}`, 'error')
        console.error('批量处理失败:', error)
        addHistoryRecord([], 'failed', error.message)
      }
    }

    async function loadFailures(){
      const res = await fetch('/api/failures')
      const j = await res.json()
      failures.value = j.failures || []
    }

    function markFailure(r){
      // 预填注释 modal
      anno.doc_id = r.doc_id
      anno.raw_text = r.raw_text
      anno.param_name = ''
      anno.param_value = ''
      annotateModal.value = true
    }

    function openAnnotate(f){
      anno.doc_id = f.doc_id
      anno.raw_text = f.raw_text
      anno.params = [{param_name: '', param_value: ''}]
      annotateModal.value = true
    }

    function addParam() {
      anno.params.push({param_name: '', param_value: ''})
    }

    function removeParam(index) {
      if (anno.params.length > 1) {
        anno.params.splice(index, 1)
      }
    }

    async function submitAnnotation(){
      // 过滤掉空的参数
      const validParams = anno.params.filter(p => p.param_name.trim() && p.param_value.trim())
      
      if (validParams.length === 0) {
        alert('请至少填写一个有效的参数名称和参数值')
        return
      }

      // 为每个参数单独提交标注
      for (const param of validParams) {
        const form = new FormData();
        form.append('doc_id', anno.doc_id)
        form.append('raw_text', anno.raw_text)
        form.append('param_name', param.param_name)
        form.append('param_value', param.param_value)
        await fetch('/api/annotations/add',{method:'POST', body: form})
      }
      
      annotateModal.value = false
      
      // 提交标注后自动触发 retrain
      await triggerRetrain()
    }

    async function triggerRetrain(){
      try {
        const response = await fetch('/api/retrain', {method: 'POST'})
        const result = await response.json()
        
        if (result.status === 'applied') {
          alert(`✅ 规则重训练成功！\n\n应用了 ${result.rules_count} 条新规则\n基于 ${result.annotations_count} 条标注数据\n\n规则库已更新，可以重新处理文档测试效果。`)
        } else if (result.status === 'no_annotations') {
          alert('⚠️ 没有找到标注数据\n\n请先对失败的文档进行人工标注，然后再次触发重训练。')
        } else if (result.status === 'no_rules_generated') {
          alert(`ℹ️ DeepSeek 未生成新规则\n\n基于 ${result.annotations_count} 条标注数据，DeepSeek 未生成新规则\n规则库保持不变。`)
        } else if (result.status === 'deepseek_disabled') {
          alert('🔧 DeepSeek 功能未启用\n\n如需使用自动规则生成功能，请启用 DeepSeek API 配置。')
        } else {
          alert(`未知状态: ${result.status}\n\n${result.message || '请检查后端日志'}`)
        }
      } catch (error) {
        alert('❌ 重训练请求失败：' + error.message)
      }
    }

    async function downloadStructured(){
      const res = await fetch('/api/structured')
      if (res.ok){
        const blob = await res.blob()
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url; a.download = 'structured.json'; document.body.appendChild(a); a.click(); a.remove();
      } else {
        alert('尚未生成 structured.json')
      }
    }

    // init
    loadFailures()
    loadHistory()

    return {
      docId, rawText, processSingle, batchProcess, results, failures, markFailure, 
      annotateModal, anno, openAnnotate, addParam, removeParam, submitAnnotation, downloadStructured,
      uploadedFiles, processingStatus, handleFileUpload, removeFile, processUploadedFiles,
      csvFile, csvUploadStatus, handleCsvUpload, removeCsvFile, uploadCsvAnnotations,
      rules, showAddRuleModal, showEditRuleModal, currentRule, loadRules, editRule, deleteRule, saveRule, closeRuleModal,
      historyRecords, successCount, failureCount, loadHistory, clearHistory, addHistoryRecord,
      triggerFileInput, triggerCsvInput, triggerRetrain,
      // 新增响应式数据和方法
      processingProgress, resultSummary, toastMessage, toastType, showToast, showVisualization,
      showToastMessage, updateProgress, showResultSummary
    }
  }
}).mount('#app')


</script>
</body>
</html>
