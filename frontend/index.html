<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡æœ¬ç»“æ„åŒ–æå–å·¥å…·</title>
  <style>
      body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      #app { 
        max-width: 1200px; 
        margin: 0 auto; 
        padding: 20px;
      }
      h2 { 
        color: #333; 
        margin: 0 0 30px 0; 
        font-size: 2.5em;
        font-weight: 300;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
      }
      .doc, div[style*="background:"] { 
        background: rgba(255,255,255,0.95); 
        backdrop-filter: blur(10px);
        padding: 25px; 
        margin-bottom: 25px; 
        border-radius: 15px; 
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .doc:hover, div[style*="background:"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      }
      .btn { 
        padding: 12px 20px; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        margin: 5px; 
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #2b8cff;
        color: #fff;
        text-decoration: none;
      }
      .btn:hover { 
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      .btn:disabled { 
        opacity: 0.6; 
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .modal { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.5); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        z-index: 1000; 
        backdrop-filter: blur(5px);
      }
      .modal-content { 
        background: white; 
        padding: 30px; 
        border-radius: 15px; 
        width: 500px; 
        max-width: 90%; 
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s ease;
      }
      @keyframes modalSlideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .form-group { 
        margin-bottom: 20px; 
      }
      label { 
        display: block; 
        margin-bottom: 8px; 
        font-weight: 600;
        color: #333;
      }
      input, textarea { 
        width: 100%; 
        padding: 12px; 
        border: 2px solid #e1e5e9; 
        border-radius: 8px; 
        box-sizing: border-box; 
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      input:focus, textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      textarea{width:100%;height:120px; min-height: 120px; resize: vertical; }
      .small{font-size:0.85em;color:#666; line-height: 1.4;}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #eee;padding:8px}
      .file-list { 
        margin-top: 15px; 
      }
      .file-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 12px; 
        background: #f8f9fa; 
        margin-bottom: 8px; 
        border-radius: 8px; 
        border-left: 4px solid #667eea;
        transition: background-color 0.3s ease;
      }
      .file-item:hover {
        background: #e9ecef;
      }
      .status-processing { 
        color: #ff9800; 
        font-weight: 600; 
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }
      .status-success { 
        color: #4caf50; 
        font-weight: 600; 
      }
      .status-error { 
        color: #f44336; 
        font-weight: 600; 
      }
      .rule-item {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #28a745;
      }
      .history-record {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        transition: transform 0.2s ease;
      }
      .history-record:hover {
        transform: translateX(5px);
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }
    </style>
</head>
<body>
  <div id="app">
    <div style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); text-align: center;">
      <h2>ğŸ“Š æ™ºèƒ½æ–‡æœ¬æŠ½å–ç³»ç»Ÿ</h2>
      <p style="color: #666; font-size: 1.1em; margin: 10px 0 0 0;">åŸºäºè§„åˆ™å’ŒAIçš„åŒ»ç–—æ–‡æ¡£ç»“æ„åŒ–ä¿¡æ¯æå–å¹³å°</p>
    </div>

    <!-- æ–‡æ¡£ä¸Šä¼ åŠŸèƒ½ -->
    <div style="margin-bottom:20px; padding:15px; background:#f5f5f5; border-radius:8px;">
      <h3>ğŸ“ æ–‡æ¡£ä¸Šä¼ </h3>
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="file" id="fileInput" multiple accept=".txt,.csv,.json" style="display:none" @change="handleFileUpload">
        <button class="btn" style="background:#2196F3" @click="triggerFileInput">
          ğŸ“„ é€‰æ‹©æ–‡ä»¶
        </button>
        <span class="small">æ”¯æŒ .txt, .csv, .json æ ¼å¼ï¼ˆå¯å¤šé€‰ï¼‰</span>
      </div>
      <div v-if="uploadedFiles.length > 0" style="margin-top:10px;">
        <div v-for="(file, index) in uploadedFiles" :key="index" style="display:flex; align-items:center; margin-bottom:5px;">
          <span style="flex:1;">{{ file.name }} ({{ (file.size/1024).toFixed(1) }}KB)</span>
          <button @click="removeFile(index)" style="background:#ff4444; color:white; border:none; padding:2px 8px; border-radius:3px; cursor:pointer;">Ã—</button>
        </div>
        <button class="btn" style="background:#4CAF50; margin-top:8px;" @click="processUploadedFiles">
          ğŸš€ å¤„ç†ä¸Šä¼ çš„æ–‡æ¡£
        </button>
        <div v-if="processingStatus" style="margin-top:8px; padding:8px; background:#e8f5e8; border-radius:4px; font-size:0.9em;">
          {{ processingStatus }}
        </div>
      </div>
    </div>

    <!-- CSVæ ‡æ³¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ -->
    <div style="margin-bottom:20px; padding:15px; background:#f8f5e8; border-radius:8px;">
      <h3>ğŸ“Š CSVæ ‡æ³¨æ–‡ä»¶ä¸Šä¼ </h3>
      <p class="small">ä¸Šä¼ åŒ…å«äººå·¥æ ‡æ³¨çš„CSVæ–‡ä»¶ï¼Œç”¨äºè§„åˆ™é‡è®­ç»ƒ</p>
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="file" id="csvInput" accept=".csv" style="display:none" @change="handleCsvUpload">
        <button class="btn" style="background:#FF9800" @click="triggerCsvInput">
          ğŸ“Š é€‰æ‹©CSVæ–‡ä»¶
        </button>
        <span class="small">æ”¯æŒæ ‡å‡†CSVæ ¼å¼ï¼ŒåŒ…å« doc_id, raw_text, param_name, param_value åˆ—</span>
      </div>
      <div v-if="csvFile" style="margin-top:10px;">
        <div style="display:flex; align-items:center;">
          <span style="flex:1;">{{ csvFile.name }} ({{ (csvFile.size/1024).toFixed(1) }}KB)</span>
          <button @click="removeCsvFile" style="background:#ff4444; color:white; border:none; padding:2px 8px; border-radius:3px; cursor:pointer;">Ã—</button>
        </div>
        <button class="btn" style="background:#4CAF50; margin-top:8px;" @click="uploadCsvAnnotations">
          ğŸ“¤ ä¸Šä¼ æ ‡æ³¨æ–‡ä»¶
        </button>
        <div v-if="csvUploadStatus" style="margin-top:8px; padding:8px; background:#e8f5e8; border-radius:4px; font-size:0.9em;">
          {{ csvUploadStatus }}
        </div>
      </div>
    </div>

    <!-- è§„åˆ™ç®¡ç†åŠŸèƒ½ -->
    <div style="margin-bottom:20px; padding:25px; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin-top:0; color:#333;">âš™ï¸ è§„åˆ™ç®¡ç†</h3>
      <p class="small">ç®¡ç†æ–‡æœ¬æŠ½å–è§„åˆ™ï¼Œæ”¯æŒæŸ¥çœ‹ã€ç¼–è¾‘ã€æ·»åŠ å’Œåˆ é™¤</p>
      
      <div style="margin-bottom:20px;">
        <button class="btn" style="background:#4CAF50" @click="loadRules">ğŸ”„ åˆ·æ–°è§„åˆ™</button>
        <button class="btn" style="background:#2196F3; margin-left:8px" @click="showAddRuleModal = true">â• æ·»åŠ è§„åˆ™</button>
      </div>
      
      <div v-if="rules.length > 0">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
          <div v-for="(rule, index) in rules" :key="index" class="rule-item">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
              <strong style="color:#333; font-size:1.1em;">{{ rule.name }}</strong>
              <div style="display:flex; gap:5px;">
                <button class="btn" style="background:#FF9800; padding:6px 12px; font-size:0.8em;" @click="editRule(index)" title="ç¼–è¾‘è§„åˆ™">âœï¸</button>
                <button class="btn" style="background:#f44336; padding:6px 12px; font-size:0.8em;" @click="deleteRule(index)" title="åˆ é™¤è§„åˆ™">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div style="font-size:0.9em; color:#555;">
              <div style="margin-bottom:8px;">
                <strong style="color:#333;">ğŸ”‘ å…³é”®è¯:</strong>
                <div style="display:flex; flex-wrap:wrap; gap:4px; margin-top:4px;">
                  <span v-for="(keyword, kIndex) in rule.keywords" :key="kIndex" style="background:#e3f2fd; color:#1976d2; padding:2px 8px; border-radius:12px; font-size:0.85em;">
                    {{ keyword }}
                  </span>
                </div>
              </div>
              <div>
                <strong style="color:#333;">ğŸ” æ­£åˆ™è¡¨è¾¾å¼:</strong>
                <div style="background:#f5f5f5; padding:8px; border-radius:6px; margin-top:4px; font-family: monospace; font-size:0.85em; word-break:break-all;">
                  {{ rule.regex || 'æ— ' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-else style="text-align:center; padding:40px; color:#666;">
        <div style="font-size:3em; margin-bottom:10px;">âš™ï¸</div>
        <p style="margin:0;">æš‚æ— è§„åˆ™</p>
        <p class="small">ç‚¹å‡»"æ·»åŠ è§„åˆ™"æŒ‰é’®æ¥åˆ›å»ºæ–°çš„æŠ½å–è§„åˆ™</p>
      </div>
    </div>

    <!-- è§„åˆ™ç¼–è¾‘/æ·»åŠ æ¨¡æ€æ¡† -->
    <div v-if="showAddRuleModal || showEditRuleModal" class="modal">
      <div class="modal-content">
        <h3 style="margin-top:0; color:#333; border-bottom:2px solid #f0f0f0; padding-bottom:15px;">
          {{ showEditRuleModal ? 'âœï¸ ç¼–è¾‘è§„åˆ™' : 'â• æ·»åŠ è§„åˆ™' }}
        </h3>
        
        <div class="form-group">
          <label>ğŸ“ è§„åˆ™åç§°:</label>
          <input type="text" v-model="currentRule.name" placeholder="è¯·è¾“å…¥è§„åˆ™åç§°ï¼ˆå¦‚ï¼šLVEFæå–è§„åˆ™ï¼‰">
        </div>
        
        <div class="form-group">
          <label>ğŸ”‘ å…³é”®è¯ (æ¯è¡Œä¸€ä¸ª):</label>
          <textarea v-model="currentRule.keywordsText" placeholder="è¯·è¾“å…¥å…³é”®è¯ï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;LVEF&#10;å°„è¡€åˆ†æ•°&#10;å·¦å®¤å°„è¡€åˆ†æ•°" style="min-height:100px;"></textarea>
          <p class="small">æ¯ä¸ªå…³é”®è¯å•ç‹¬ä¸€è¡Œï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«åŒ…å«è¿™äº›å…³é”®è¯çš„æ–‡æœ¬</p>
        </div>
        
        <div class="form-group">
          <label>ğŸ” æ­£åˆ™è¡¨è¾¾å¼:</label>
          <input type="text" v-model="currentRule.regex" placeholder="è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼ï¼ˆå¦‚ï¼š\\d+%?ï¼‰">
          <p class="small">ç”¨äºç²¾ç¡®åŒ¹é…å’Œæå–æ•°å€¼ï¼Œå¦‚ï¼š\\d+%? åŒ¹é…æ•°å­—å’Œç™¾åˆ†æ¯”</p>
        </div>
        
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:30px; padding-top:20px; border-top:1px solid #f0f0f0;">
          <button class="btn" style="background:#666;" @click="closeRuleModal">å–æ¶ˆ</button>
          <button class="btn" style="background:#4CAF50;" @click="saveRule">{{ showEditRuleModal ? 'æ›´æ–°è§„åˆ™' : 'æ·»åŠ è§„åˆ™' }}</button>
        </div>
      </div>
    </div>

    <!-- å¤„ç†å†å²è®°å½•åŠŸèƒ½ -->
    <div style="margin-bottom:20px; padding:25px; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin-top:0; color:#333;">ğŸ“Š å¤„ç†å†å²è®°å½•</h3>
      <p class="small">æŸ¥çœ‹ä¹‹å‰çš„å¤„ç†ç»“æœå’Œç»Ÿè®¡ä¿¡æ¯</p>
      
      <div style="margin-bottom:20px;">
        <button class="btn" style="background:#2196F3" @click="loadHistory">ğŸ”„ åˆ·æ–°å†å²</button>
        <button class="btn" style="background:#FF9800; margin-left:8px" @click="clearHistory">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
      </div>
      
      <div v-if="historyRecords.length > 0">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">{{ historyRecords.length }}</div>
            <div class="stat-label">æ€»å¤„ç†æ¬¡æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ successCount }}</div>
            <div class="stat-label">æˆåŠŸå¤„ç†</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ failureCount }}</div>
            <div class="stat-label">å¤±è´¥å¤„ç†</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ historyRecords.reduce((total, r) => total + r.extractedParams, 0) }}</div>
            <div class="stat-label">æ€»æå–å‚æ•°</div>
          </div>
        </div>
        
        <!-- å†å²è®°å½•åˆ—è¡¨ -->
        <div v-for="(record, index) in historyRecords" :key="index" class="history-record">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <strong style="color:#333;">{{ record.timestamp }}</strong>
            <span :style="{color: record.status === 'success' ? '#4CAF50' : '#ff4444', background: record.status === 'success' ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 68, 68, 0.1)', padding: '4px 12px', borderRadius: '20px', fontSize: '0.9em'}">
              {{ record.status === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥' }}
            </span>
          </div>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size:0.9em;">
            <div><strong>ğŸ“„ æ–‡æ¡£æ•°é‡:</strong> {{ record.documentCount }}</div>
            <div><strong>ğŸ” æå–å‚æ•°:</strong> {{ record.extractedParams }}</div>
            <div v-if="record.error" style="grid-column: 1 / -1; color:#ff4444; background:rgba(255,68,68,0.1); padding:8px; border-radius:6px;">
              <strong>é”™è¯¯ä¿¡æ¯:</strong> {{ record.error }}
            </div>
          </div>
        </div>
      </div>
      <div v-else style="text-align:center; padding:40px; color:#666;">
        <div style="font-size:3em; margin-bottom:10px;">ğŸ“‹</div>
        <p style="margin:0;">æš‚æ— å¤„ç†å†å²è®°å½•</p>
        <p class="small">å¼€å§‹å¤„ç†æ–‡æ¡£åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå¤„ç†å†å²</p>
      </div>
    </div>

    <!-- æ–‡æœ¬è¾“å…¥åŠŸèƒ½ -->
    <div style="margin-bottom:20px; padding:15px; background:#f5f5f5; border-radius:8px;">
      <h3>ğŸ“ æ–‡æœ¬è¾“å…¥</h3>
      <div>
        <label>Doc ID: <input v-model="docId" /></label>
      </div>
      <div style="margin-top:8px">
        <textarea v-model="rawText" placeholder="åœ¨æ­¤ç²˜è´´æ£€æŸ¥æŠ¥å‘Šæˆ–ç—…å†åŸæ–‡..."></textarea>
      </div>
      <div style="margin-top:8px">
        <button class="btn" @click="processSingle">å¤„ç†å½“å‰æ–‡æœ¬</button>
        <button class="btn" style="background:#4caf50;margin-left:8px" @click="batchProcess">å¤„ç†ç¤ºä¾‹æ‰¹é‡</button>
        <button class="btn" style="background:#777;margin-left:8px" @click="downloadStructured">ä¸‹è½½ JSON</button>
      </div>
    </div>

    <h3 style="margin-top:20px">å¤„ç†ç»“æœ</h3>
    <div v-if="results.length===0"><em>æš‚æ— ç»“æœ</em></div>
    <div v-for="r in results" :key="r.doc_id" class="doc">
      <strong>{{r.doc_id}}</strong>
      <div class="small">{{r.raw_text}}</div>
      
      <!-- é€è¡Œå¤„ç†ç»“æœ -->
      <div style="margin-top:12px; border:1px solid #e0e0e0; border-radius:4px; padding:8px; background:#f9f9f9;">
        <h4 style="margin:0 0 8px 0; font-size:14px;">ğŸ“ é€è¡Œå¤„ç†ç»“æœ</h4>
        <div v-for="line in r.line_results" :key="line.line_number" style="margin-bottom:8px; padding:6px; border-left:3px solid #4caf50; background:white;">
          <div style="font-size:12px; color:#666;">ç¬¬{{line.line_number}}è¡Œ:</div>
          <div style="font-size:13px; margin:4px 0;">{{line.line_text}}</div>
          <div v-if="line.extracted && line.extracted.length > 0" style="font-size:12px;">
            <span style="color:#4caf50;">âœ… æå–åˆ°å‚æ•°:</span>
            <span v-for="e in line.extracted" :key="e.param_name" style="margin-left:8px; background:#e8f5e8; padding:2px 6px; border-radius:3px;">
              {{e.param_name}}: {{e.param_value}}
            </span>
          </div>
          <div v-else style="font-size:12px; color:#ff9800;">
            âš ï¸ æœªæå–åˆ°å‚æ•°
          </div>
        </div>
      </div>
      
      <!-- æ±‡æ€»ç»“æœ -->
      <div style="margin-top:12px;">
        <h4 style="margin:0 0 8px 0; font-size:14px;">ğŸ“Š æ±‡æ€»ç»“æœ</h4>
        <table>
          <thead><tr><th>å‚æ•°å</th><th>å€¼</th><th>æ¥æºè¡Œå·</th></tr></thead>
          <tbody>
            <tr v-for="e in r.extracted" :key="e.param_name">
              <td>{{e.param_name}}</td>
              <td>{{e.param_value}}</td>
              <td>
                <span v-for="line in r.line_results" :key="line.line_number">
                  <span v-if="line.extracted && line.extracted.some(ext => ext.param_name === e.param_name && ext.param_value === e.param_value)">
                    {{line.line_number}}
                  </span>
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div style="margin-top:8px">
        <span class="small">çŠ¶æ€: {{r.status}}</span>
        <span class="small" style="margin-left:12px;">æ€»è¡Œæ•°: {{r.line_results ? r.line_results.length : 0}}</span>
        <span class="small" style="margin-left:12px;">æˆåŠŸè¡Œæ•°: {{r.line_results ? r.line_results.filter(l => l.extracted && l.extracted.length > 0).length : 0}}</span>
        <button style="margin-left:8px" @click="markFailure(r)">æ ‡æ³¨ä¸ºå¤±è´¥å¹¶æ·»åŠ äººå·¥æ³¨é‡Š</button>
      </div>
    </div>

    <h3 style="margin-top:20px">å¤±è´¥è®°å½•ï¼ˆæ¥è‡ªåç«¯ï¼‰</h3>
    <div style="margin-bottom:12px">
      <button class="btn" style="background:#ff9800;" @click="triggerRetrain">è§¦å‘ Retrain</button>
      <span class="small" style="margin-left:8px">åŸºäºå½“å‰æ ‡æ³¨æ•°æ®é‡æ–°è®­ç»ƒè§„åˆ™</span>
    </div>
    <div v-if="failures.length===0"><em>æ— </em></div>
    <div v-for="f in failures" :key="f.doc_id" class="doc">
      <strong>{{f.doc_id}}</strong>
      <div class="small">{{f.raw_text}}</div>
      <div class="small">åŸå› : {{f.reason}}</div>
      <div style="margin-top:8px">
        <button @click="openAnnotate(f)" class="btn">äººå·¥æ ‡æ³¨</button>
      </div>
    </div>

    <!-- ç®€å•çš„æ³¨é‡Šå¼¹çª— -->
    <div v-if="annotateModal" style="position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center">
      <div style="background:#fff;padding:20px;border-radius:8px;width:600px">
        <h4>æ·»åŠ äººå·¥æ ‡æ³¨</h4>
        <div>Doc ID: <input v-model="anno.doc_id" /></div>
        <div style="margin-top:8px">Raw Text:<br/><textarea v-model="anno.raw_text" style="height:80px"></textarea></div>
        <div style="margin-top:8px">Param Name: <input v-model="anno.param_name" /></div>
        <div style="margin-top:8px">Param Value: <input v-model="anno.param_value" /></div>
        <div style="margin-top:12px">
          <button class="btn" @click="submitAnnotation">æäº¤</button>
          <button class="btn" style="background:#999;margin-left:8px" @click="annotateModal=false">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

  </div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const { createApp, ref, reactive } = Vue;
createApp({
  setup(){
    const docId = ref('DOC1')
    const rawText = ref('æ£€æŸ¥æŠ¥å‘Šï¼šå·¦å®¤å£å¼¥æ¼«æ€§è¿åŠ¨å‡å¼± å·¦å®¤æ”¶ç¼©åŠŸèƒ½é™ä½ï¼ˆLVEF: 40%ï¼‰ å¤‡æ³¨: æ— å…¶ä»–å¼‚å¸¸')
    const results = ref([])
    const failures = ref([])
    const annotateModal = ref(false)
    const anno = reactive({doc_id:'', raw_text:'', param_name:'', param_value:''})
    const uploadedFiles = ref([])
    const processingStatus = ref('')
    const csvFile = ref(null)
    const csvUploadStatus = ref('')
    const rules = ref([])
    const showAddRuleModal = ref(false)
    const showEditRuleModal = ref(false)
    const currentRule = reactive({
      name: '',
      keywordsText: '',
      regex: '',
      index: -1
    })
    const historyRecords = ref([])

    // æ–‡æ¡£ä¸Šä¼ ç›¸å…³å‡½æ•°
    function triggerFileInput() {
      const fileInput = document.getElementById('fileInput')
      if (fileInput) {
        fileInput.click()
      }
    }
    
    function triggerCsvInput() {
      const csvInput = document.getElementById('csvInput')
      if (csvInput) {
        csvInput.click()
      }
    }
    
    function handleFileUpload(event) {
      const files = Array.from(event.target.files)
      uploadedFiles.value = [...uploadedFiles.value, ...files]
      event.target.value = '' // æ¸…ç©ºinputä»¥ä¾¿å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
    }

    function removeFile(index) {
      uploadedFiles.value.splice(index, 1)
    }

    async function processUploadedFiles() {
      if (uploadedFiles.value.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶')
        return
      }

      processingStatus.value = 'æ­£åœ¨è¯»å–å’Œå¤„ç†ä¸Šä¼ çš„æ–‡ä»¶...'
      
      try {
        const documents = []
        
        for (const file of uploadedFiles.value) {
          const content = await readFileContent(file)
          const docId = file.name.replace(/\.[^/.]+$/, '') // ä½¿ç”¨æ–‡ä»¶åä½œä¸ºdoc_id
          documents.push({ doc_id: docId, raw_text: content })
        }

        processingStatus.value = `æ­£åœ¨å¤„ç† ${documents.length} ä¸ªæ–‡æ¡£...`
        
        const payload = { documents }
        const res = await fetch('/api/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`)
        }
        
        const j = await res.json()
        
        // è°ƒè¯•ä¿¡æ¯ï¼šæ‰“å°æ¥æ”¶åˆ°çš„ç»“æœ
        console.log('APIå“åº”ç»“æœ:', j)
        console.log('å¤„ç†ç»“æœæ•°é‡:', j.results.length)
        
        // ç¡®ä¿ç»“æœæ­£ç¡®æ˜¾ç¤º - ä½¿ç”¨Vueçš„å“åº”å¼æ›´æ–°
        results.value = [...j.results]
        
        // å¼ºåˆ¶è§¦å‘Vueæ›´æ–°
        await new Promise(resolve => setTimeout(resolve, 0))
        
        processingStatus.value = `å¤„ç†å®Œæˆï¼å…±å¤„ç† ${documents.length} ä¸ªæ–‡æ¡£ï¼Œæå–åˆ° ${j.results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)} ä¸ªå‚æ•°`
        
        // æ¸…ç©ºå·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
        uploadedFiles.value = []
        
        // æ›´æ–° failures
        await loadFailures()
        
        // æ·»åŠ å†å²è®°å½•
        addHistoryRecord(j.results, 'success')
        
        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
        setTimeout(() => {
          const resultsSection = document.querySelector('h3[style*="margin-top:20px"]')
          if (resultsSection) {
            resultsSection.scrollIntoView({ behavior: 'smooth' })
          }
        }, 100)
        
      } catch (error) {
        processingStatus.value = 'å¤„ç†å¤±è´¥'
        alert('æ–‡æ¡£å¤„ç†å¤±è´¥ï¼š' + error.message)
        console.error('æ–‡æ¡£å¤„ç†é”™è¯¯:', error)
        // æ·»åŠ å¤±è´¥å†å²è®°å½•
        addHistoryRecord([], 'failed', error.message)
      }
    }

    function readFileContent(file) {
      return new Promise((resolve, reject) => {
        // å°è¯•å¤šç§ç¼–ç æ–¹å¼ï¼Œä¼˜å…ˆä½¿ç”¨è‡ªåŠ¨æ£€æµ‹
        const encodings = ['UTF-8', 'GBK', 'GB2312', 'BIG5', 'ISO-8859-1', 'UTF-16LE', 'UTF-16BE']
        
        const tryNextEncoding = (index) => {
          if (index >= encodings.length) {
            // å¦‚æœæ‰€æœ‰ç¼–ç éƒ½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨TextDecoderè¿›è¡Œæ™ºèƒ½è§£ç 
            const reader = new FileReader()
            reader.onload = (e) => {
              const arrayBuffer = e.target.result
              try {
                // å°è¯•ä½¿ç”¨UTF-8è§£ç 
                const decoder = new TextDecoder('utf-8')
                const content = decoder.decode(arrayBuffer)
                if (!containsGarbledText(content)) {
                  resolve(content)
                } else {
                  // å°è¯•GBKè§£ç 
                  try {
                    const gbkDecoder = new TextDecoder('gbk')
                    const gbkContent = gbkDecoder.decode(arrayBuffer)
                    resolve(gbkContent)
                  } catch (gbkError) {
                    reject(new Error('æ— æ³•è¯†åˆ«æ–‡ä»¶ç¼–ç ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ä¸­æ–‡æ–‡æœ¬'))
                  }
                }
              } catch (error) {
                reject(new Error('æ–‡ä»¶è§£ç å¤±è´¥ï¼š' + error.message))
              }
            }
            reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'))
            reader.readAsArrayBuffer(file)
            return
          }
          
          const encoding = encodings[index]
          const reader = new FileReader()
          
          reader.onload = (e) => {
            const content = e.target.result
            // æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«ä¹±ç 
            if (!containsGarbledText(content)) {
              console.log(`æˆåŠŸä½¿ç”¨ç¼–ç  ${encoding} è¯»å–æ–‡ä»¶`)
              resolve(content)
            } else {
              console.log(`ç¼–ç  ${encoding} æ£€æµ‹åˆ°ä¹±ç ï¼Œå°è¯•ä¸‹ä¸€ä¸ªç¼–ç `)
              // å¦‚æœæ£€æµ‹åˆ°ä¹±ç ï¼Œå°è¯•ä¸‹ä¸€ä¸ªç¼–ç 
              tryNextEncoding(index + 1)
            }
          }
          
          reader.onerror = () => {
            console.log(`ç¼–ç  ${encoding} è¯»å–å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªç¼–ç `)
            // å½“å‰ç¼–ç è¯»å–å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª
            tryNextEncoding(index + 1)
          }
          
          // ä½¿ç”¨æŒ‡å®šçš„ç¼–ç è¯»å–æ–‡ä»¶
          reader.readAsText(file, encoding)
        }
        
        // å¼€å§‹å°è¯•ç¼–ç 
        tryNextEncoding(0)
      })
    }
    
    // æ£€æµ‹æ–‡æœ¬æ˜¯å¦åŒ…å«ä¹±ç 
    function containsGarbledText(text) {
      // å¸¸è§çš„ä¸­æ–‡ä¹±ç æ¨¡å¼
      const garbledPatterns = [
        /[\uFFFD]/g, // Unicodeæ›¿æ¢å­—ç¬¦
        /[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, // æ§åˆ¶å­—ç¬¦
        /[Ã€-Ã¿]{2,}/g, // è¿ç»­çš„æ‹‰ä¸å­—æ¯æ‰©å±•å­—ç¬¦ï¼ˆå¯èƒ½æ˜¯GBKä¹±ç ï¼‰
        /[ÃƒÃ‚Ã„Ã…Ã†Ã‡ÃˆÃ‰ÃŠÃ‹ÃŒÃÃÃÃÃ‘Ã’Ã“Ã”Ã•Ã–Ã—Ã˜Ã™ÃšÃ›ÃœÃÃÃŸÃ Ã¡Ã¢Ã£Ã¤Ã¥Ã¦Ã§Ã¨Ã©ÃªÃ«Ã¬Ã­Ã®Ã¯Ã°Ã±Ã²Ã³Ã´ÃµÃ¶Ã·Ã¸Ã¹ÃºÃ»Ã¼Ã½Ã¾Ã¿]{2,}/g // æ›´å¤šå¯èƒ½çš„ä¹±ç æ¨¡å¼
      ]
      
      // æ£€æŸ¥ä¸­æ–‡å­—ç¬¦æ¯”ä¾‹ï¼ˆå¦‚æœæ–‡æœ¬å¾ˆé•¿ä½†ä¸­æ–‡å­—ç¬¦å¾ˆå°‘ï¼Œå¯èƒ½æ˜¯ä¹±ç ï¼‰
      const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || []
      const totalChars = text.length
      const chineseRatio = chineseChars.length / totalChars
      
      // å¦‚æœæ–‡æœ¬é•¿åº¦è¶…è¿‡100å­—ç¬¦ä½†ä¸­æ–‡æ¯”ä¾‹ä½äº5%ï¼Œå¯èƒ½æœ‰é—®é¢˜
      if (totalChars > 100 && chineseRatio < 0.05) {
        return true
      }
      
      // æ£€æŸ¥ä¹±ç æ¨¡å¼
      for (const pattern of garbledPatterns) {
        if (pattern.test(text)) {
          return true
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦åŒ…å«ç”¨æˆ·æåˆ°çš„ç‰¹å®šä¹±ç æ¨¡å¼
      if (text.includes('ï¿½ï¿½é±¨ï¿½æ£ºï¿½ï¿½ï¿½Ò±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¶ï¿½ï¿½ï¿½ï¿½ï¿½')) {
        return true
      }
      
      return false
    }

    // CSVæ ‡æ³¨æ–‡ä»¶ä¸Šä¼ ç›¸å…³å‡½æ•°
    function handleCsvUpload(event) {
      const files = event.target.files
      if (files.length > 0) {
        csvFile.value = files[0]
      }
      event.target.value = '' // æ¸…ç©ºinputä»¥ä¾¿å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
    }

    function removeCsvFile() {
      csvFile.value = null
      csvUploadStatus.value = ''
    }

    async function uploadCsvAnnotations() {
      if (!csvFile.value) {
        alert('è¯·å…ˆé€‰æ‹©CSVæ–‡ä»¶')
        return
      }

      csvUploadStatus.value = 'æ­£åœ¨ä¸Šä¼ CSVæ ‡æ³¨æ–‡ä»¶...'
      
      try {
        const formData = new FormData()
        formData.append('file', csvFile.value)
        
        const res = await fetch('/api/annotations/upload', {
          method: 'POST',
          body: formData
        })
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`)
        }
        
        const result = await res.json()
        csvUploadStatus.value = 'CSVæ ‡æ³¨æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼'
        
        // ä¸Šä¼ æˆåŠŸåè‡ªåŠ¨è§¦å‘é‡è®­ç»ƒ
        setTimeout(async () => {
          await triggerRetrain()
        }, 1000)
        
      } catch (error) {
        csvUploadStatus.value = 'CSVæ–‡ä»¶ä¸Šä¼ å¤±è´¥'
        alert('CSVæ ‡æ³¨æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š' + error.message)
        console.error('CSVä¸Šä¼ é”™è¯¯:', error)
      }
    }

    // è§„åˆ™ç®¡ç†ç›¸å…³å‡½æ•°
    async function loadRules() {
      try {
        // è¿™é‡Œéœ€è¦æ·»åŠ åç«¯APIæ¥è·å–è§„åˆ™
        // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        const mockRules = [
          {
            name: 'LVEFæå–è§„åˆ™',
            keywords: ['LVEF', 'å°„è¡€åˆ†æ•°', 'å·¦å®¤å°„è¡€åˆ†æ•°'],
            regex: 'LVEF[ï¼š:\\s]*([0-9]+)%'
          },
          {
            name: 'å·¦å®¤æ”¶ç¼©åŠŸèƒ½è§„åˆ™',
            keywords: ['å·¦å®¤æ”¶ç¼©åŠŸèƒ½', 'æ”¶ç¼©åŠŸèƒ½', 'å¿ƒå®¤æ”¶ç¼©'],
            regex: 'å·¦å®¤æ”¶ç¼©åŠŸèƒ½[ï¼š:\\s]*(é™ä½|å‡å¼±|æ­£å¸¸|ä¸‹é™)'
          }
        ]
        rules.value = mockRules
      } catch (error) {
        console.error('åŠ è½½è§„åˆ™å¤±è´¥:', error)
        alert('åŠ è½½è§„åˆ™å¤±è´¥ï¼š' + error.message)
      }
    }

    function editRule(index) {
      const rule = rules.value[index]
      currentRule.name = rule.name
      currentRule.keywordsText = rule.keywords ? rule.keywords.join('\\n') : ''
      currentRule.regex = rule.regex || ''
      currentRule.index = index
      showEditRuleModal.value = true
    }

    function deleteRule(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
        rules.value.splice(index, 1)
        // è¿™é‡Œéœ€è¦æ·»åŠ åç«¯APIæ¥ä¿å­˜è§„åˆ™å˜æ›´
        alert('è§„åˆ™åˆ é™¤æˆåŠŸï¼ˆå‰ç«¯æ¼”ç¤ºï¼‰')
      }
    }

    function saveRule() {
      if (!currentRule.name.trim()) {
        alert('è¯·è¾“å…¥è§„åˆ™åç§°')
        return
      }

      const keywords = currentRule.keywordsText
        .split('\\n')
        .map(k => k.trim())
        .filter(k => k.length > 0)

      const newRule = {
        name: currentRule.name.trim(),
        keywords: keywords,
        regex: currentRule.regex.trim()
      }

      if (showEditRuleModal.value && currentRule.index >= 0) {
        // ç¼–è¾‘ç°æœ‰è§„åˆ™
        rules.value[currentRule.index] = newRule
      } else {
        // æ·»åŠ æ–°è§„åˆ™
        rules.value.push(newRule)
      }

      // è¿™é‡Œéœ€è¦æ·»åŠ åç«¯APIæ¥ä¿å­˜è§„åˆ™
      alert('è§„åˆ™ä¿å­˜æˆåŠŸï¼ˆå‰ç«¯æ¼”ç¤ºï¼‰')
      closeRuleModal()
    }

    function closeRuleModal() {
      showAddRuleModal.value = false
      showEditRuleModal.value = false
      currentRule.name = ''
      currentRule.keywordsText = ''
      currentRule.regex = ''
      currentRule.index = -1
    }

    // å¤„ç†å†å²è®°å½•ç›¸å…³å‡½æ•°
    function loadHistory() {
      // ä»localStorageåŠ è½½å†å²è®°å½•
      try {
        const savedHistory = localStorage.getItem('extractionHistory')
        if (savedHistory) {
          historyRecords.value = JSON.parse(savedHistory)
        } else {
          historyRecords.value = []
        }
      } catch (error) {
        console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error)
        historyRecords.value = []
      }
    }

    function clearHistory() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¤„ç†å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        historyRecords.value = []
        localStorage.removeItem('extractionHistory')
        alert('å†å²è®°å½•å·²æ¸…ç©º')
      }
    }

    function addHistoryRecord(results, status = 'success', error = null) {
      const record = {
        timestamp: new Date().toLocaleString('zh-CN'),
        documentCount: results.length,
        extractedParams: results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0),
        status: status,
        error: error
      }
      
      historyRecords.value.unshift(record) // æ·»åŠ åˆ°å¼€å¤´
      
      // åªä¿ç•™æœ€è¿‘50æ¡è®°å½•
      if (historyRecords.value.length > 50) {
        historyRecords.value = historyRecords.value.slice(0, 50)
      }
      
      // ä¿å­˜åˆ°localStorage
      try {
        localStorage.setItem('extractionHistory', JSON.stringify(historyRecords.value))
      } catch (error) {
        console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error)
      }
    }

    // è®¡ç®—å±æ€§ï¼šæˆåŠŸæ¬¡æ•°
    const successCount = Vue.computed(() => {
      return historyRecords.value.filter(r => r.status === 'success').length
    })
    
    // è®¡ç®—å±æ€§ï¼šå¤±è´¥æ¬¡æ•°
    const failureCount = Vue.computed(() => {
      return historyRecords.value.filter(r => r.status === 'failed').length
    })

    async function processSingle(){
      try {
        const payload = {documents:[{doc_id:docId.value, raw_text:rawText.value}]}
        const res = await fetch('/api/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        const j = await res.json()
        results.value = j.results
        // æ›´æ–° failures
        await loadFailures()
        // æ·»åŠ å†å²è®°å½•
        addHistoryRecord(j.results, 'success')
      } catch (error) {
        console.error('å¤„ç†å¤±è´¥:', error)
        addHistoryRecord([], 'failed', error.message)
      }
    }

    async function batchProcess(){
      try {
        // ç®€å•ç¤ºä¾‹æ‰¹é‡
        const docs = [
          {doc_id:'A', raw_text:'æ£€æŸ¥æŠ¥å‘Šï¼šå·¦å®¤å£å¼¥æ¼«æ€§è¿åŠ¨å‡å¼± å·¦å®¤æ”¶ç¼©åŠŸèƒ½é™ä½ï¼ˆLVEF: 40%ï¼‰ å¤‡æ³¨: æ— å…¶ä»–å¼‚å¸¸'},
          {doc_id:'B', raw_text:'è¶…å£°æ˜¾ç¤ºï¼šLVEF=55%ï¼Œèˆ’å¼ åŠŸèƒ½æ­£å¸¸ã€‚å·¦å¿ƒæˆ¿å¢å¤§ã€‚'},
          {doc_id:'C', raw_text:'å¿ƒç”µå›¾ï¼šçª¦æ€§å¿ƒå¾‹ï¼ŒSTæ®µè½»å¾®æŠ¬é«˜ã€‚è¯„ä¼°ï¼šå¿ƒè‚Œç¼ºè¡€å¯èƒ½ã€‚'},
          {doc_id:'D', raw_text:'ç—…å†å°ç»“ï¼šæ‚£è€…ä¸»è¯‰èƒ¸é—·ï¼Œå¿ƒå®¤è‚Œæ”¶ç¼©åŠ›å‡å¼±ï¼Œå°„è¡€åˆ†æ•°å¤§çº¦ä¸º 38% å·¦å³ã€‚'},
          {doc_id:'E', raw_text:'å¤‡æ³¨ï¼šLVEFå¤§çº¦å››æˆã€‚'}
        ]
        const res = await fetch('/api/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({documents:docs})})
        const j = await res.json()
        results.value = j.results
        await loadFailures()
        // æ·»åŠ å†å²è®°å½•
        addHistoryRecord(j.results, 'success')
      } catch (error) {
        console.error('æ‰¹é‡å¤„ç†å¤±è´¥:', error)
        addHistoryRecord([], 'failed', error.message)
      }
    }

    async function loadFailures(){
      const res = await fetch('/api/failures')
      const j = await res.json()
      failures.value = j.failures || []
    }

    function markFailure(r){
      // é¢„å¡«æ³¨é‡Š modal
      anno.doc_id = r.doc_id
      anno.raw_text = r.raw_text
      anno.param_name = ''
      anno.param_value = ''
      annotateModal.value = true
    }

    function openAnnotate(f){
      anno.doc_id = f.doc_id
      anno.raw_text = f.raw_text
      annotateModal.value = true
    }

    async function submitAnnotation(){
      const form = new FormData();
      form.append('doc_id', anno.doc_id)
      form.append('raw_text', anno.raw_text)
      form.append('param_name', anno.param_name)
      form.append('param_value', anno.param_value)
      await fetch('/api/annotations/add',{method:'POST', body: form})
      annotateModal.value = false
      
      // æäº¤æ ‡æ³¨åè‡ªåŠ¨è§¦å‘ retrain
      await triggerRetrain()
    }

    async function triggerRetrain(){
      try {
        const response = await fetch('/api/retrain', {method: 'POST'})
        const result = await response.json()
        
        if (result.status === 'applied') {
          alert(`âœ… è§„åˆ™é‡è®­ç»ƒæˆåŠŸï¼\n\nåº”ç”¨äº† ${result.rules_count} æ¡æ–°è§„åˆ™\nåŸºäº ${result.annotations_count} æ¡æ ‡æ³¨æ•°æ®\n\nè§„åˆ™åº“å·²æ›´æ–°ï¼Œå¯ä»¥é‡æ–°å¤„ç†æ–‡æ¡£æµ‹è¯•æ•ˆæœã€‚`)
        } else if (result.status === 'no_annotations') {
          alert('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ ‡æ³¨æ•°æ®\n\nè¯·å…ˆå¯¹å¤±è´¥çš„æ–‡æ¡£è¿›è¡Œäººå·¥æ ‡æ³¨ï¼Œç„¶åå†æ¬¡è§¦å‘é‡è®­ç»ƒã€‚')
        } else if (result.status === 'no_rules_generated') {
          alert(`â„¹ï¸ DeepSeek æœªç”Ÿæˆæ–°è§„åˆ™\n\nåŸºäº ${result.annotations_count} æ¡æ ‡æ³¨æ•°æ®ï¼ŒDeepSeek æœªç”Ÿæˆæ–°è§„åˆ™\nè§„åˆ™åº“ä¿æŒä¸å˜ã€‚`)
        } else if (result.status === 'deepseek_disabled') {
          alert('ğŸ”§ DeepSeek åŠŸèƒ½æœªå¯ç”¨\n\nå¦‚éœ€ä½¿ç”¨è‡ªåŠ¨è§„åˆ™ç”ŸæˆåŠŸèƒ½ï¼Œè¯·å¯ç”¨ DeepSeek API é…ç½®ã€‚')
        } else {
          alert(`æœªçŸ¥çŠ¶æ€: ${result.status}\n\n${result.message || 'è¯·æ£€æŸ¥åç«¯æ—¥å¿—'}`)
        }
      } catch (error) {
        alert('âŒ é‡è®­ç»ƒè¯·æ±‚å¤±è´¥ï¼š' + error.message)
      }
    }

    async function downloadStructured(){
      const res = await fetch('/api/structured')
      if (res.ok){
        const blob = await res.blob()
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url; a.download = 'structured.json'; document.body.appendChild(a); a.click(); a.remove();
      } else {
        alert('å°šæœªç”Ÿæˆ structured.json')
      }
    }

    // init
    loadFailures()
    loadHistory()

    return {
      docId, rawText, processSingle, batchProcess, results, failures, markFailure, 
      annotateModal, anno, openAnnotate, submitAnnotation, downloadStructured,
      uploadedFiles, processingStatus, handleFileUpload, removeFile, processUploadedFiles,
      csvFile, csvUploadStatus, handleCsvUpload, removeCsvFile, uploadCsvAnnotations,
      rules, showAddRuleModal, showEditRuleModal, currentRule, loadRules, editRule, deleteRule, saveRule, closeRuleModal,
      historyRecords, successCount, failureCount, loadHistory, clearHistory, addHistoryRecord,
      triggerFileInput, triggerCsvInput, triggerRetrain
    }
  }
}).mount('#app')


</script>
</body>
</html>
