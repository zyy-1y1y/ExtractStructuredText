<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡æœ¬ç»“æ„åŒ–æå–å·¥å…·</title>
  <style>
      body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      #app { 
        max-width: 1200px; 
        margin: 0 auto; 
        padding: 20px;
      }
      h2 { 
        color: #333; 
        margin: 0 0 30px 0; 
        font-size: 2.5em;
        font-weight: 300;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
      }
      .doc, div[style*="background:"] { 
        background: rgba(255,255,255,0.95); 
        backdrop-filter: blur(10px);
        padding: 25px; 
        margin-bottom: 25px; 
        border-radius: 15px; 
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .doc:hover, div[style*="background:"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      }
      .btn { 
        padding: 12px 20px; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        margin: 5px; 
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #2b8cff;
        color: #fff;
        text-decoration: none;
      }
      .btn:hover { 
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      .btn:disabled { 
        opacity: 0.6; 
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .modal { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.5); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        z-index: 1000; 
        backdrop-filter: blur(5px);
      }
      .modal-content { 
        background: white; 
        padding: 30px; 
        border-radius: 15px; 
        width: 500px; 
        max-width: 90%; 
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s ease;
      }
      @keyframes modalSlideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .form-group { 
        margin-bottom: 20px; 
      }
      label { 
        display: block; 
        margin-bottom: 8px; 
        font-weight: 600;
        color: #333;
      }
      input, textarea { 
        width: 100%; 
        padding: 12px; 
        border: 2px solid #e1e5e9; 
        border-radius: 8px; 
        box-sizing: border-box; 
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      input:focus, textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      textarea{width:100%;height:120px; min-height: 120px; resize: vertical; }
      .small{font-size:0.85em;color:#666; line-height: 1.4;}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #eee;padding:8px}
      .file-list { 
        margin-top: 15px; 
      }
      .file-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 12px; 
        background: #f8f9fa; 
        margin-bottom: 8px; 
        border-radius: 8px; 
        border-left: 4px solid #667eea;
        transition: background-color 0.3s ease;
      }
      .file-item:hover {
        background: #e9ecef;
      }
      .status-processing { 
        color: #ff9800; 
        font-weight: 600; 
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }
      .status-success { 
        color: #4caf50; 
        font-weight: 600; 
      }
      .status-error { 
        color: #f44336; 
        font-weight: 600; 
      }
      .rule-item {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #28a745;
      }
      .history-record {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        transition: transform 0.2s ease;
      }
      .history-record:hover {
        transform: translateX(5px);
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }
      
      /* æ–°å¢ï¼šå¤„ç†ç»“æœæç¤ºæ ·å¼ */
      .success-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        z-index: 1001;
        animation: slideInRight 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .error-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #f44336, #d32f2f);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
        z-index: 1001;
        animation: slideInRight 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
      
      /* è¿›åº¦æ¡æ ·å¼ */
      .progress-container {
        width: 100%;
        background: #f0f0f0;
        border-radius: 10px;
        margin: 15px 0;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      }
      
      .progress-bar {
        height: 12px;
        background: linear-gradient(90deg, #4CAF50, #45a049, #2E7D32);
        border-radius: 10px;
        transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        width: 0%;
        position: relative;
        overflow: hidden;
      }
      
      .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shimmer 2s infinite;
      }
      
      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }
      
      .progress-text {
        font-size: 0.95em;
        color: #333;
        margin-top: 8px;
        text-align: center;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .progress-status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        font-size: 0.9em;
        color: #666;
      }
      
      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4CAF50;
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .processing-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin: 15px 0;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #4CAF50;
      }
      
      .stat-item {
        text-align: center;
        padding: 8px;
      }
      
      .stat-value {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
      }
      
      .stat-label {
        font-size: 0.8em;
        color: #666;
        margin-top: 2px;
      }
      
      /* ç»“æœç»Ÿè®¡å¡ç‰‡æ ·å¼ */
      .result-summary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 25px;
        border-radius: 15px;
        margin: 20px 0;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }
      
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      
      .summary-item {
        text-align: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        transition: transform 0.2s ease, background 0.2s ease;
      }
      
      .summary-item:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.3);
      }
      
      .summary-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .summary-label {
        font-size: 0.85em;
        opacity: 0.9;
      }
      
      /* å¯è§†åŒ–å›¾è¡¨æ ·å¼ */
      .visualization-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      
      .chart-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        backdrop-filter: blur(10px);
      }
      
      .chart-title {
        font-size: 1.1em;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
      }
      
      .chart-bar {
        height: 20px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        margin: 5px 0;
        overflow: hidden;
        position: relative;
      }
      
      .chart-fill {
        height: 100%;
        background: linear-gradient(90deg, #4CAF50, #8BC34A);
        border-radius: 10px;
        transition: width 0.5s ease;
      }
      
      .chart-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.8em;
        margin-bottom: 5px;
      }
      
      /* å‚æ•°åˆ†å¸ƒæ ·å¼ */
      .param-distribution {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      
      .param-tag {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      
      /* æ€§èƒ½æŒ‡æ ‡æ ·å¼ */
      .performance-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      
      .metric-item {
        text-align: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
      }
      
      .metric-value {
        font-size: 1.4em;
        font-weight: bold;
        margin-bottom: 5px;
      }
      
      .metric-label {
        font-size: 0.8em;
        opacity: 0.9;
      }
    </style>
</head>
<body>
  <div id="app">
    <div style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); text-align: center;">
      <h2>æ™ºèƒ½æ–‡æœ¬æå–ç³»ç»Ÿ</h2>
      <p style="color: #666; font-size: 1.1em; margin: 10px 0 0 0;">åŸºäºè§„åˆ™å’ŒAIçš„åŒ»ç–—æ–‡æ¡£ç»“æ„åŒ–ä¿¡æ¯æå–å¹³å°</p>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ç»„ä»¶ -->
    <div v-if="showToast" :class="toastType === 'success' ? 'success-toast' : toastType === 'error' ? 'error-toast' : 'success-toast'">
      <span v-if="toastType === 'success'" style="font-size:1.2em;">âœ…</span>
      <span v-if="toastType === 'error'" style="font-size:1.2em;">âŒ</span>
      <span v-if="toastType === 'warning'" style="font-size:1.2em;">âš ï¸</span>
      <span>{{ toastMessage }}</span>
    </div>

    <!-- æ–‡æ¡£ä¸Šä¼ åŠŸèƒ½ -->
    <div style="margin-bottom:20px; padding:25px; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin-top:0; color:#333;">ğŸ“ æ–‡æ¡£ä¸Šä¼ ä¸å¤„ç†</h3>
      <p class="small">ä¸Šä¼ æ–‡æ¡£è¿›è¡Œç»“æ„åŒ–ä¿¡æ¯æå–ï¼Œæ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼</p>
      
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
        <input type="file" id="fileInput" multiple accept=".txt,.csv,.json" style="display:none" @change="handleFileUpload">
        <button class="btn" style="background:#2196F3" @click="triggerFileInput">
          ğŸ“„ é€‰æ‹©æ–‡ä»¶
        </button>
        <span class="small">æ”¯æŒ .txt, .csv, .json æ ¼å¼ï¼ˆå¯å¤šé€‰ï¼‰</span>
      </div>
      
      <!-- æ–‡ä»¶åˆ—è¡¨å’Œè¿›åº¦æ˜¾ç¤º -->
      <div v-if="uploadedFiles.length > 0" style="margin-top:15px;">
        <div style="margin-bottom:15px;">
          <h4 style="margin:0 0 10px 0; color:#333;">ğŸ“‹ å·²é€‰æ‹©æ–‡ä»¶ ({{ uploadedFiles.length }} ä¸ª)</h4>
          <div v-for="(file, index) in uploadedFiles" :key="index" class="file-item">
            <div style="display:flex; align-items:center; gap:10px; flex:1;">
              <span style="font-weight:600;">{{ file.name }}</span>
              <span class="small">({{ (file.size/1024).toFixed(1) }}KB)</span>
            </div>
            <button @click="removeFile(index)" style="background:#ff4444; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:12px;">ç§»é™¤</button>
          </div>
        </div>
        
        <!-- è¿›åº¦æ¡å’ŒçŠ¶æ€æ˜¾ç¤º -->
        <div v-if="processingProgress.show" style="margin-bottom:20px;">
          <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
          <div class="progress-status">
            <div class="status-indicator"></div>
            <span>æ­£åœ¨å¤„ç†ä¸­...</span>
          </div>
          
          <!-- å®æ—¶ç»Ÿè®¡ä¿¡æ¯ -->
          <div v-if="processingProgress.value > 0 && processingProgress.value < 100" class="processing-stats">
            <div class="stat-item">
              <div class="stat-value">{{ uploadedFiles.length }}</div>
              <div class="stat-label">å¾…å¤„ç†æ–‡æ¡£</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ Math.round(processingProgress.value) }}%</div>
              <div class="stat-label">å¤„ç†è¿›åº¦</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ processingProgress.estimatedTime || '--' }}</div>
              <div class="stat-label">é¢„è®¡å‰©ä½™</div>
            </div>
          </div>
          
          <!-- è¿›åº¦æ¡ -->
          <div class="progress-container">
            <div class="progress-bar" :style="{ width: processingProgress.value + '%' }"></div>
          </div>
          
          <!-- è¿›åº¦æ–‡æœ¬ -->
          <div class="progress-text">
            <span v-if="processingProgress.value < 100">ğŸ”„</span>
            <span v-if="processingProgress.value === 100">âœ…</span>
            {{ processingProgress.text }}
          </div>
        </div>
        
        <button class="btn" style="background:#4CAF50;" @click="processUploadedFiles" :disabled="processingProgress.show">
          ğŸš€ å¼€å§‹å¤„ç†æ–‡æ¡£
        </button>
      </div>
    </div>
    
    <!-- å¤„ç†ç»“æœç»Ÿè®¡ -->
    <div v-if="resultSummary.show" class="result-summary">
      <h3 style="margin:0 0 10px 0; color:white;">ğŸ‰ å¤„ç†å®Œæˆï¼</h3>
      <p style="margin:0; opacity:0.9;">æ–‡æ¡£å¤„ç†å·²å®Œæˆï¼Œä»¥ä¸‹æ˜¯å¤„ç†ç»“æœç»Ÿè®¡ï¼š</p>
      
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-number">{{ resultSummary.totalDocuments }}</div>
          <div class="summary-label">å¤„ç†æ–‡æ¡£</div>
        </div>
        <div class="summary-item">
          <div class="summary-number">{{ resultSummary.extractedParams }}</div>
          <div class="summary-label">æå–å‚æ•°</div>
        </div>
        <div class="summary-item">
          <div class="summary-number">{{ resultSummary.totalLines }}</div>
          <div class="summary-label">å¤„ç†è¡Œæ•°</div>
        </div>
        <div class="summary-item">
          <div class="summary-number">{{ resultSummary.successLines }}</div>
          <div class="summary-label">æˆåŠŸè¡Œæ•°</div>
        </div>
      </div>
      
      <!-- å¯è§†åŒ–åˆ†æåŒºåŸŸ -->
      <div v-if="showVisualization" class="visualization-grid">
        <!-- å¤„ç†æˆåŠŸç‡å›¾è¡¨ -->
        <div class="chart-container">
          <div class="chart-title">ğŸ“ˆ å¤„ç†æˆåŠŸç‡</div>
          <div class="chart-label">
            <span>æˆåŠŸç‡</span>
            <span>{{ resultSummary.successRate }}%</span>
          </div>
          <div class="chart-bar">
            <div class="chart-fill" :style="{ width: resultSummary.successRate + '%' }"></div>
          </div>
          <div style="font-size:0.8em; text-align:center; margin-top:5px;">
            {{ resultSummary.successLines }} / {{ resultSummary.totalLines }} è¡Œ
          </div>
        </div>
        
        <!-- å‚æ•°åˆ†å¸ƒå›¾è¡¨ -->
        <div class="chart-container">
          <div class="chart-title">ğŸ” å‚æ•°åˆ†å¸ƒ</div>
          <div v-if="resultSummary.paramDistribution && resultSummary.paramDistribution.length > 0">
            <div v-for="param in resultSummary.paramDistribution.slice(0, 5)" :key="param.name" class="chart-label">
              <span>{{ param.name }}</span>
              <span>{{ param.count }}</span>
            </div>
            <div v-if="resultSummary.paramDistribution.length > 5" style="font-size:0.8em; text-align:center; margin-top:5px;">
              è¿˜æœ‰ {{ resultSummary.paramDistribution.length - 5 }} ä¸ªå‚æ•°
            </div>
          </div>
          <div v-else style="text-align:center; opacity:0.7; font-size:0.9em;">
            æš‚æ— å‚æ•°æ•°æ®
          </div>
        </div>
        
        <!-- æ€§èƒ½æŒ‡æ ‡ -->
        <div class="chart-container">
          <div class="chart-title">âš¡ æ€§èƒ½æŒ‡æ ‡</div>
          <div class="performance-metrics">
            <div class="metric-item">
              <div class="metric-value">{{ resultSummary.processingTime }}s</div>
              <div class="metric-label">å¤„ç†æ—¶é—´</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">{{ resultSummary.documentsPerSecond }}</div>
              <div class="metric-label">æ–‡æ¡£/ç§’</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">{{ resultSummary.paramsPerSecond }}</div>
              <div class="metric-label">å‚æ•°/ç§’</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å‚æ•°æ ‡ç­¾äº‘ -->
      <div v-if="resultSummary.paramDistribution && resultSummary.paramDistribution.length > 0" style="margin-top:20px;">
        <div style="font-size:1.1em; font-weight:bold; margin-bottom:10px;">ğŸ·ï¸ æå–çš„å‚æ•°ç±»å‹</div>
        <div class="param-distribution">
          <span v-for="param in resultSummary.paramDistribution" :key="param.name" class="param-tag">
            {{ param.name }} ({{ param.count }})
          </span>
        </div>
      </div>
      
      <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3);" @click="scrollToResults">
          ğŸ“Š æŸ¥çœ‹è¯¦ç»†ç»“æœ
        </button>
        <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3);" @click="downloadStructured">
          ğŸ“¥ ä¸‹è½½JSONç»“æœ
        </button>
        <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3);" @click="showVisualization = !showVisualization">
          ğŸ“ˆ {{ showVisualization ? 'éšè—' : 'æ˜¾ç¤º' }}å¯è§†åŒ–
        </button>
      </div>
    </div>

    <!-- CSVæ ‡æ³¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ -->
    <div style="margin-bottom:20px; padding:15px; background:#f8f5e8; border-radius:8px;">
      <h3>ğŸ“Š CSVæ ‡æ³¨æ–‡ä»¶ä¸Šä¼ </h3>
      <p class="small">ä¸Šä¼ åŒ…å«äººå·¥æ ‡æ³¨çš„CSVæ–‡ä»¶ï¼Œç”¨äºè§„åˆ™é‡è®­ç»ƒ</p>
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="file" id="csvInput" accept=".csv" style="display:none" @change="handleCsvUpload">
        <button class="btn" style="background:#FF9800" @click="triggerCsvInput">
          ğŸ“Š é€‰æ‹©CSVæ–‡ä»¶
        </button>
        <span class="small">æ”¯æŒæ ‡å‡†CSVæ ¼å¼ï¼ŒåŒ…å« doc_id, raw_text, param_name, param_value åˆ—</span>
      </div>
      <div v-if="csvFile" style="margin-top:10px;">
        <div style="display:flex; align-items:center;">
          <span style="flex:1;">{{ csvFile.name }} ({{ (csvFile.size/1024).toFixed(1) }}KB)</span>
          <button @click="removeCsvFile" style="background:#ff4444; color:white; border:none; padding:2px 8px; border-radius:3px; cursor:pointer;">Ã—</button>
        </div>
        <button class="btn" style="background:#4CAF50; margin-top:8px;" @click="uploadCsvAnnotations">
          ğŸ“¤ ä¸Šä¼ æ ‡æ³¨æ–‡ä»¶
        </button>
        <div v-if="csvUploadStatus" style="margin-top:8px; padding:8px; background:#e8f5e8; border-radius:4px; font-size:0.9em;">
          {{ csvUploadStatus }}
        </div>
      </div>
    </div>

    <!-- è§„åˆ™ç®¡ç†åŠŸèƒ½ -->
    <div style="margin-bottom:20px; padding:25px; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin-top:0; color:#333;">âš™ï¸ è§„åˆ™ç®¡ç†</h3>
      <p class="small">ç®¡ç†æ–‡æœ¬æŠ½å–è§„åˆ™ï¼Œæ”¯æŒæŸ¥çœ‹ã€ç¼–è¾‘ã€æ·»åŠ å’Œåˆ é™¤</p>
      
      <div style="margin-bottom:20px;">
        <button class="btn" style="background:#4CAF50" @click="loadRules">ğŸ”„ åˆ·æ–°è§„åˆ™</button>
        <button class="btn" style="background:#2196F3; margin-left:8px" @click="showAddRuleModal = true">â• æ·»åŠ è§„åˆ™</button>
      </div>
      
      <div v-if="rules.length > 0">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
          <div v-for="(rule, index) in rules" :key="index" class="rule-item">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
              <strong style="color:#333; font-size:1.1em;">{{ rule.name }}</strong>
              <div style="display:flex; gap:5px;">
                <button class="btn" style="background:#FF9800; padding:6px 12px; font-size:0.8em;" @click="editRule(index)" title="ç¼–è¾‘è§„åˆ™">âœï¸</button>
                <button class="btn" style="background:#f44336; padding:6px 12px; font-size:0.8em;" @click="deleteRule(index)" title="åˆ é™¤è§„åˆ™">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div style="font-size:0.9em; color:#555;">
              <div style="margin-bottom:8px;">
                <strong style="color:#333;">ğŸ”‘ å…³é”®è¯:</strong>
                <div style="display:flex; flex-wrap:wrap; gap:4px; margin-top:4px;">
                  <span v-for="(keyword, kIndex) in rule.keywords" :key="kIndex" style="background:#e3f2fd; color:#1976d2; padding:2px 8px; border-radius:12px; font-size:0.85em;">
                    {{ keyword }}
                  </span>
                </div>
              </div>
              <div>
                <strong style="color:#333;">ğŸ” æ­£åˆ™è¡¨è¾¾å¼:</strong>
                <div style="background:#f5f5f5; padding:8px; border-radius:6px; margin-top:4px; font-family: monospace; font-size:0.85em; word-break:break-all;">
                  {{ rule.regex || 'æ— ' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-else style="text-align:center; padding:40px; color:#666;">
        <div style="font-size:3em; margin-bottom:10px;">âš™ï¸</div>
        <p style="margin:0;">æš‚æ— è§„åˆ™</p>
        <p class="small">ç‚¹å‡»"æ·»åŠ è§„åˆ™"æŒ‰é’®æ¥åˆ›å»ºæ–°çš„æŠ½å–è§„åˆ™</p>
      </div>
    </div>

    <!-- è§„åˆ™ç¼–è¾‘/æ·»åŠ æ¨¡æ€æ¡† -->
    <div v-if="showAddRuleModal || showEditRuleModal" class="modal">
      <div class="modal-content">
        <h3 style="margin-top:0; color:#333; border-bottom:2px solid #f0f0f0; padding-bottom:15px;">
          {{ showEditRuleModal ? 'âœï¸ ç¼–è¾‘è§„åˆ™' : 'â• æ·»åŠ è§„åˆ™' }}
        </h3>
        
        <div class="form-group">
          <label>ğŸ“ è§„åˆ™åç§°:</label>
          <input type="text" v-model="currentRule.name" placeholder="è¯·è¾“å…¥è§„åˆ™åç§°ï¼ˆå¦‚ï¼šLVEFæå–è§„åˆ™ï¼‰">
        </div>
        
        <div class="form-group">
          <label>ğŸ”‘ å…³é”®è¯ (æ¯è¡Œä¸€ä¸ª):</label>
          <textarea v-model="currentRule.keywordsText" placeholder="è¯·è¾“å…¥å…³é”®è¯ï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;LVEF&#10;å°„è¡€åˆ†æ•°&#10;å·¦å®¤å°„è¡€åˆ†æ•°" style="min-height:100px;"></textarea>
          <p class="small">æ¯ä¸ªå…³é”®è¯å•ç‹¬ä¸€è¡Œï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«åŒ…å«è¿™äº›å…³é”®è¯çš„æ–‡æœ¬</p>
        </div>
        
        <div class="form-group">
          <label>ğŸ” æ­£åˆ™è¡¨è¾¾å¼:</label>
          <input type="text" v-model="currentRule.regex" placeholder="è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼ï¼ˆå¦‚ï¼š\\d+%?ï¼‰">
          <p class="small">ç”¨äºç²¾ç¡®åŒ¹é…å’Œæå–æ•°å€¼ï¼Œå¦‚ï¼š\\d+%? åŒ¹é…æ•°å­—å’Œç™¾åˆ†æ¯”</p>
        </div>
        
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:30px; padding-top:20px; border-top:1px solid #f0f0f0;">
          <button class="btn" style="background:#666;" @click="closeRuleModal">å–æ¶ˆ</button>
          <button class="btn" style="background:#4CAF50;" @click="saveRule">{{ showEditRuleModal ? 'æ›´æ–°è§„åˆ™' : 'æ·»åŠ è§„åˆ™' }}</button>
        </div>
      </div>
    </div>

    <!-- å¤„ç†å†å²è®°å½•åŠŸèƒ½ -->
    <div style="margin-bottom:20px; padding:25px; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin-top:0; color:#333;">ğŸ“Š å¤„ç†å†å²è®°å½•</h3>
      <p class="small">æŸ¥çœ‹ä¹‹å‰çš„å¤„ç†ç»“æœå’Œç»Ÿè®¡ä¿¡æ¯</p>
      
      <div style="margin-bottom:20px;">
        <button class="btn" style="background:#2196F3" @click="loadHistory">ğŸ”„ åˆ·æ–°å†å²</button>
        <button class="btn" style="background:#FF9800; margin-left:8px" @click="clearHistory">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
      </div>
      
      <div v-if="historyRecords.length > 0">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">{{ historyRecords.length }}</div>
            <div class="stat-label">æ€»å¤„ç†æ¬¡æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ successCount }}</div>
            <div class="stat-label">æˆåŠŸå¤„ç†</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ failureCount }}</div>
            <div class="stat-label">å¤±è´¥å¤„ç†</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ historyRecords.reduce((total, r) => total + r.extractedParams, 0) }}</div>
            <div class="stat-label">æ€»æå–å‚æ•°</div>
          </div>
        </div>
        
        <!-- å†å²è®°å½•åˆ—è¡¨ -->
        <div v-for="(record, index) in historyRecords" :key="index" class="history-record">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <strong style="color:#333;">{{ record.timestamp }}</strong>
            <span :style="{color: record.status === 'success' ? '#4CAF50' : '#ff4444', background: record.status === 'success' ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 68, 68, 0.1)', padding: '4px 12px', borderRadius: '20px', fontSize: '0.9em'}">
              {{ record.status === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥' }}
            </span>
          </div>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size:0.9em;">
            <div><strong>ğŸ“„ æ–‡æ¡£æ•°é‡:</strong> {{ record.documentCount }}</div>
            <div><strong>ğŸ” æå–å‚æ•°:</strong> {{ record.extractedParams }}</div>
            <div v-if="record.error" style="grid-column: 1 / -1; color:#ff4444; background:rgba(255,68,68,0.1); padding:8px; border-radius:6px;">
              <strong>é”™è¯¯ä¿¡æ¯:</strong> {{ record.error }}
            </div>
          </div>
        </div>
      </div>
      <div v-else style="text-align:center; padding:40px; color:#666;">
        <div style="font-size:3em; margin-bottom:10px;">ğŸ“‹</div>
        <p style="margin:0;">æš‚æ— å¤„ç†å†å²è®°å½•</p>
        <p class="small">å¼€å§‹å¤„ç†æ–‡æ¡£åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå¤„ç†å†å²</p>
      </div>
    </div>

    <!-- æ–‡æœ¬è¾“å…¥åŠŸèƒ½ -->
    <div style="margin-bottom:20px; padding:15px; background:#f5f5f5; border-radius:8px;">
      <h3>ğŸ“ æ–‡æœ¬è¾“å…¥</h3>
      <div>
        <label>Doc ID: <input v-model="docId" /></label>
      </div>
      <div style="margin-top:8px">
        <textarea v-model="rawText" placeholder="åœ¨æ­¤ç²˜è´´æ£€æŸ¥æŠ¥å‘Šæˆ–ç—…å†åŸæ–‡..."></textarea>
      </div>
      <div style="margin-top:8px">
        <button class="btn" @click="processSingle">å¤„ç†å½“å‰æ–‡æœ¬</button>
        <button class="btn" style="background:#4caf50;margin-left:8px" @click="batchProcess">å¤„ç†ç¤ºä¾‹æ‰¹é‡</button>
        <button class="btn" style="background:#777;margin-left:8px" @click="downloadStructured">ä¸‹è½½ JSON</button>
      </div>
    </div>

    <h3 style="margin-top:20px">å¤„ç†ç»“æœ</h3>
    <div v-if="results.length===0"><em>æš‚æ— ç»“æœ</em></div>
    <div v-for="r in results" :key="r.doc_id" class="doc">
      <strong>{{r.doc_id}}</strong>
      <div class="small">{{r.raw_text}}</div>
      
      <!-- é€è¡Œå¤„ç†ç»“æœ -->
      <div style="margin-top:12px; border:1px solid #e0e0e0; border-radius:4px; padding:8px; background:#f9f9f9;">
        <h4 style="margin:0 0 8px 0; font-size:14px;">ğŸ“ é€è¡Œå¤„ç†ç»“æœ</h4>
        <div v-for="line in r.line_results" :key="line.line_number" style="margin-bottom:8px; padding:6px; border-left:3px solid #4caf50; background:white;">
          <div style="font-size:12px; color:#666;">ç¬¬{{line.line_number}}è¡Œ:</div>
          <div style="font-size:13px; margin:4px 0;">{{line.line_text}}</div>
          <div v-if="line.extracted && line.extracted.length > 0" style="font-size:12px;">
            <span style="color:#4caf50;">âœ… æå–åˆ°å‚æ•°:</span>
            <span v-for="e in line.extracted" :key="e.param_name" style="margin-left:8px; background:#e8f5e8; padding:2px 6px; border-radius:3px;">
              {{e.param_name}}: {{e.param_value}}
            </span>
          </div>
          <div v-else style="font-size:12px; color:#ff9800;">
            âš ï¸ æœªæå–åˆ°å‚æ•°
          </div>
        </div>
      </div>
      
      <!-- æ±‡æ€»ç»“æœ -->
      <div style="margin-top:12px;">
        <h4 style="margin:0 0 8px 0; font-size:14px;">ğŸ“Š æ±‡æ€»ç»“æœ</h4>
        <table>
          <thead><tr><th>å‚æ•°å</th><th>å€¼</th><th>æ¥æºè¡Œå·</th></tr></thead>
          <tbody>
            <tr v-for="e in r.extracted" :key="e.param_name">
              <td>{{e.param_name}}</td>
              <td>{{e.param_value}}</td>
              <td>
                <span v-for="line in r.line_results" :key="line.line_number">
                  <span v-if="line.extracted && line.extracted.some(ext => ext.param_name === e.param_name && ext.param_value === e.param_value)">
                    {{line.line_number}}
                  </span>
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div style="margin-top:8px">
        <span class="small">çŠ¶æ€: {{r.status}}</span>
        <span class="small" style="margin-left:12px;">æ€»è¡Œæ•°: {{r.line_results ? r.line_results.length : 0}}</span>
        <span class="small" style="margin-left:12px;">æˆåŠŸè¡Œæ•°: {{r.line_results ? r.line_results.filter(l => l.extracted && l.extracted.length > 0).length : 0}}</span>
        <button style="margin-left:8px" @click="markFailure(r)">æ ‡æ³¨ä¸ºå¤±è´¥å¹¶æ·»åŠ äººå·¥æ³¨é‡Š</button>
      </div>
    </div>

    <h3 style="margin-top:20px">å¤±è´¥è®°å½•ï¼ˆæ¥è‡ªåç«¯ï¼‰</h3>
    <div style="margin-bottom:12px">
      <button class="btn" style="background:#ff9800;" @click="triggerRetrain">è§¦å‘ Retrain</button>
      <span class="small" style="margin-left:8px">åŸºäºå½“å‰æ ‡æ³¨æ•°æ®é‡æ–°è®­ç»ƒè§„åˆ™</span>
    </div>
    <div v-if="failures.length===0"><em>æ— </em></div>
    <div v-for="f in failures" :key="f.doc_id" class="doc">
      <strong>{{f.doc_id}}</strong>
      <div class="small">{{f.raw_text}}</div>
      <div class="small">åŸå› : {{f.reason}}</div>
      <div style="margin-top:8px">
        <button @click="openAnnotate(f)" class="btn">äººå·¥æ ‡æ³¨</button>
      </div>
    </div>

    <!-- æ”¯æŒå¤šå‚æ•°çš„æ³¨é‡Šå¼¹çª— -->
    <div v-if="annotateModal" style="position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center">
      <div style="background:#fff;padding:20px;border-radius:8px;width:700px;max-height:80vh;overflow-y:auto">
        <h4>æ·»åŠ äººå·¥æ ‡æ³¨</h4>
        <div>Doc ID: <input v-model="anno.doc_id" readonly style="background:#f5f5f5" /></div>
        <div style="margin-top:8px">åŸå§‹æ–‡æœ¬:<br/><textarea v-model="anno.raw_text" style="height:80px;width:100%" readonly></textarea></div>
        
        <div style="margin-top:16px;border-top:1px solid #eee;padding-top:16px">
          <h5>å‚æ•°æ ‡æ³¨</h5>
          <div v-for="(param, index) in anno.params" :key="index" style="margin-bottom:12px;padding:12px;border:1px solid #ddd;border-radius:4px">
            <div style="display:flex;gap:8px;align-items:center">
              <div style="flex:1">
                <div>å‚æ•°åç§°:</div>
                <input v-model="param.param_name" placeholder="ä¾‹å¦‚ï¼šLVEF" style="width:100%" />
              </div>
              <div style="flex:1">
                <div>å‚æ•°å€¼:</div>
                <input v-model="param.param_value" placeholder="ä¾‹å¦‚ï¼š40%" style="width:100%" />
              </div>
              <div style="margin-top:20px">
                <button @click="removeParam(index)" style="background:#ff4444;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer">åˆ é™¤</button>
              </div>
            </div>
          </div>
          
          <button @click="addParam()" style="background:#4CAF50;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-bottom:16px">+ æ·»åŠ å‚æ•°</button>
        </div>
        
        <div style="margin-top:16px;border-top:1px solid #eee;padding-top:16px">
          <button class="btn" @click="submitAnnotation">æäº¤æ ‡æ³¨</button>
          <button class="btn" style="background:#999;margin-left:8px" @click="annotateModal=false">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

  </div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const { createApp, ref, reactive } = Vue;
createApp({
  setup(){
    const docId = ref('DOC1')
    const rawText = ref('æ£€æŸ¥æŠ¥å‘Šï¼šå·¦å®¤å£å¼¥æ¼«æ€§è¿åŠ¨å‡å¼± å·¦å®¤æ”¶ç¼©åŠŸèƒ½é™ä½ï¼ˆLVEF: 40%ï¼‰ å¤‡æ³¨: æ— å…¶ä»–å¼‚å¸¸')
    const results = ref([])
    const failures = ref([])
    const annotateModal = ref(false)
    const anno = reactive({doc_id:'', raw_text:'', params: [{param_name: '', param_value: ''}]})
    const uploadedFiles = ref([])
    const processingStatus = ref('')
    const csvFile = ref(null)
    const csvUploadStatus = ref('')
    const rules = ref([])
    const showAddRuleModal = ref(false)
    const showEditRuleModal = ref(false)
    const currentRule = reactive({
      name: '',
      keywordsText: '',
      regex: '',
      index: -1
    })
    const historyRecords = ref([])
    
    // æ–°å¢å“åº”å¼æ•°æ®ï¼šå¤„ç†è¿›åº¦å’Œç»“æœç»Ÿè®¡
    const processingProgress = reactive({
      show: false,
      value: 0,
      text: 'æ­£åœ¨å¤„ç†...',
      estimatedTime: '--',
      startTime: null
    })
    
    const resultSummary = reactive({
      show: false,
      totalDocuments: 0,
      totalLines: 0,
      successLines: 0,
      extractedParams: 0,
      processingTime: 0,
      successRate: 0,
      documentsPerSecond: '0.0',
      paramsPerSecond: '0.0',
      paramDistribution: []
    })
    
    const showVisualization = ref(true)
    
    const toastMessage = ref('')
    const toastType = ref('success') // success, error, warning
    const showToast = ref(false)

    // æ–°å¢å‡½æ•°ï¼šæ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToastMessage(message, type = 'success') {
      toastMessage.value = message
      toastType.value = type
      showToast.value = true
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        showToast.value = false
      }, 3000)
    }
    
    // æ–°å¢å‡½æ•°ï¼šæ›´æ–°å¤„ç†è¿›åº¦
    function updateProgress(value, text) {
      processingProgress.value = value
      processingProgress.text = text
      processingProgress.show = true
      
      // è®¡ç®—é¢„è®¡å‰©ä½™æ—¶é—´
      if (value > 0 && value < 100) {
        if (!processingProgress.startTime) {
          processingProgress.startTime = Date.now()
        }
        
        const elapsedTime = Date.now() - processingProgress.startTime
        const estimatedTotalTime = (elapsedTime / value) * 100
        const remainingTime = estimatedTotalTime - elapsedTime
        
        if (remainingTime > 0) {
          const minutes = Math.floor(remainingTime / 60000)
          const seconds = Math.floor((remainingTime % 60000) / 1000)
          
          if (minutes > 0) {
            processingProgress.estimatedTime = `${minutes}åˆ†${seconds}ç§’`
          } else {
            processingProgress.estimatedTime = `${seconds}ç§’`
          }
        }
      }
    }
    
    // æ–°å¢å‡½æ•°ï¼šæ˜¾ç¤ºç»“æœç»Ÿè®¡
    function showResultSummary(results, processingTime) {
      const totalDocuments = results.length
      const totalLines = results.reduce((total, r) => total + (r.raw_text ? r.raw_text.split('\n').length : 0), 0)
      const successLines = results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)
      const extractedParams = results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)
      
      // è®¡ç®—æˆåŠŸç‡
      const successRate = totalLines > 0 ? Math.round((successLines / totalLines) * 100) : 0
      
      // è®¡ç®—æ€§èƒ½æŒ‡æ ‡
      const documentsPerSecond = parseFloat(processingTime) > 0 ? (totalDocuments / parseFloat(processingTime)).toFixed(1) : '0.0'
      const paramsPerSecond = parseFloat(processingTime) > 0 ? (extractedParams / parseFloat(processingTime)).toFixed(1) : '0.0'
      
      // åˆ†æå‚æ•°åˆ†å¸ƒ
      const paramDistribution = analyzeParamDistribution(results)
      
      resultSummary.totalDocuments = totalDocuments
      resultSummary.totalLines = totalLines
      resultSummary.successLines = successLines
      resultSummary.extractedParams = extractedParams
      resultSummary.processingTime = processingTime
      resultSummary.successRate = successRate
      resultSummary.documentsPerSecond = documentsPerSecond
      resultSummary.paramsPerSecond = paramsPerSecond
      resultSummary.paramDistribution = paramDistribution
      resultSummary.show = true
    }
    
    // æ–°å¢å‡½æ•°ï¼šåˆ†æå‚æ•°åˆ†å¸ƒ
    function analyzeParamDistribution(results) {
      const paramCounts = {}
      
      results.forEach(result => {
        if (result.extracted && Array.isArray(result.extracted)) {
          result.extracted.forEach(param => {
            if (param.name) {
              paramCounts[param.name] = (paramCounts[param.name] || 0) + 1
            }
          })
        }
      })
      
      // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ•°é‡æ’åº
      return Object.entries(paramCounts)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count)
    }
    
    // æ–°å¢å‡½æ•°ï¼šæ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
    function scrollToResults() {
      const resultsSection = document.querySelector('h3[style*="margin-top:20px"]')
      if (resultsSection) {
        resultsSection.scrollIntoView({ behavior: 'smooth' })
      }
    }
    
    // æ–‡æ¡£ä¸Šä¼ ç›¸å…³å‡½æ•°
    function triggerFileInput() {
      const fileInput = document.getElementById('fileInput')
      if (fileInput) {
        fileInput.click()
      }
    }
    
    function triggerCsvInput() {
      const csvInput = document.getElementById('csvInput')
      if (csvInput) {
        csvInput.click()
      }
    }
    
    function handleFileUpload(event) {
      const files = Array.from(event.target.files)
      uploadedFiles.value = [...uploadedFiles.value, ...files]
      event.target.value = '' // æ¸…ç©ºinputä»¥ä¾¿å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
    }

    function removeFile(index) {
      uploadedFiles.value.splice(index, 1)
    }

    async function processUploadedFiles() {
      if (uploadedFiles.value.length === 0) {
        showToastMessage('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'warning')
        return
      }

      const startTime = Date.now()
      
      // é‡ç½®è¿›åº¦çŠ¶æ€
      processingProgress.startTime = Date.now()
      processingProgress.estimatedTime = '--'
      
      // æ˜¾ç¤ºå¤„ç†è¿›åº¦
      updateProgress(0, 'æ­£åœ¨å‡†å¤‡å¤„ç†æ–‡ä»¶...')
      processingStatus.value = 'æ­£åœ¨è¯»å–å’Œå¤„ç†ä¸Šä¼ çš„æ–‡ä»¶...'
      
      try {
        const documents = []
        
        // è¯»å–æ–‡ä»¶å†…å®¹å¹¶æ›´æ–°è¿›åº¦
        for (let i = 0; i < uploadedFiles.value.length; i++) {
          const file = uploadedFiles.value[i]
          updateProgress((i / uploadedFiles.value.length) * 40, `æ­£åœ¨è¯»å–æ–‡ä»¶: ${file.name}...`)
          
          const content = await readFileContent(file)
          const docId = file.name.replace(/\.[^/.]+$/, '') // ä½¿ç”¨æ–‡ä»¶åä½œä¸ºdoc_id
          documents.push({ doc_id: docId, raw_text: content })
        }

        updateProgress(50, `æ­£åœ¨å¤„ç† ${documents.length} ä¸ªæ–‡æ¡£...`)
        processingStatus.value = `æ­£åœ¨å¤„ç† ${documents.length} ä¸ªæ–‡æ¡£...`
        
        const payload = { documents }
        const res = await fetch('/api/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`)
        }
        
        updateProgress(80, 'æ­£åœ¨è§£æå¤„ç†ç»“æœ...')
        const j = await res.json()
        
        // è°ƒè¯•ä¿¡æ¯ï¼šæ‰“å°æ¥æ”¶åˆ°çš„ç»“æœ
        console.log('APIå“åº”ç»“æœ:', j)
        console.log('å¤„ç†ç»“æœæ•°é‡:', j.results.length)
        
        // ç¡®ä¿ç»“æœæ­£ç¡®æ˜¾ç¤º - ä½¿ç”¨Vueçš„å“åº”å¼æ›´æ–°
        results.value = [...j.results]
        
        // å¼ºåˆ¶è§¦å‘Vueæ›´æ–°
        await new Promise(resolve => setTimeout(resolve, 0))
        
        const processingTime = ((Date.now() - startTime) / 1000).toFixed(2)
        const extractedParams = j.results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)
        
        updateProgress(100, 'å¤„ç†å®Œæˆï¼')
        processingStatus.value = `å¤„ç†å®Œæˆï¼å…±å¤„ç† ${documents.length} ä¸ªæ–‡æ¡£ï¼Œæå–åˆ° ${extractedParams} ä¸ªå‚æ•°ï¼Œè€—æ—¶ ${processingTime} ç§’`
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showToastMessage(`æ–‡ä»¶å¤„ç†å®Œæˆï¼æˆåŠŸå¤„ç† ${documents.length} ä¸ªæ–‡æ¡£ï¼Œæå–åˆ° ${extractedParams} ä¸ªå‚æ•°ã€‚`, 'success')
        
        // æ˜¾ç¤ºç»“æœç»Ÿè®¡
        showResultSummary(j.results, processingTime)
        
        // æ¸…ç©ºå·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
        uploadedFiles.value = []
        
        // æ›´æ–° failures
        await loadFailures()
        
        // æ·»åŠ å†å²è®°å½•
        addHistoryRecord(j.results, 'success')
        
        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
        setTimeout(() => {
          const resultsSection = document.querySelector('h3[style*="margin-top:20px"]')
          if (resultsSection) {
            resultsSection.scrollIntoView({ behavior: 'smooth' })
          }
        }, 100)
        
        // 2ç§’åéšè—è¿›åº¦æ¡
        setTimeout(() => {
          processingProgress.show = false
          processingProgress.value = 0
          processingProgress.startTime = null
          processingProgress.estimatedTime = '--'
        }, 2000)
        
      } catch (error) {
        processingProgress.show = false
        processingProgress.value = 0
        processingProgress.startTime = null
        processingProgress.estimatedTime = '--'
        processingStatus.value = 'å¤„ç†å¤±è´¥'
        showToastMessage(`æ–‡æ¡£å¤„ç†å¤±è´¥ï¼š${error.message}`, 'error')
        console.error('æ–‡æ¡£å¤„ç†é”™è¯¯:', error)
        // æ·»åŠ å¤±è´¥å†å²è®°å½•
        addHistoryRecord([], 'failed', error.message)
      }
    }

    function readFileContent(file) {
      return new Promise((resolve, reject) => {
        // å°è¯•å¤šç§ç¼–ç æ–¹å¼ï¼Œä¼˜å…ˆä½¿ç”¨è‡ªåŠ¨æ£€æµ‹
        const encodings = ['UTF-8', 'GBK', 'GB2312', 'BIG5', 'ISO-8859-1', 'UTF-16LE', 'UTF-16BE']
        
        const tryNextEncoding = (index) => {
          if (index >= encodings.length) {
            // å¦‚æœæ‰€æœ‰ç¼–ç éƒ½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨TextDecoderè¿›è¡Œæ™ºèƒ½è§£ç 
            const reader = new FileReader()
            reader.onload = (e) => {
              const arrayBuffer = e.target.result
              try {
                // å°è¯•ä½¿ç”¨UTF-8è§£ç 
                const decoder = new TextDecoder('utf-8')
                const content = decoder.decode(arrayBuffer)
                if (!containsGarbledText(content)) {
                  resolve(content)
                } else {
                  // å°è¯•GBKè§£ç 
                  try {
                    const gbkDecoder = new TextDecoder('gbk')
                    const gbkContent = gbkDecoder.decode(arrayBuffer)
                    resolve(gbkContent)
                  } catch (gbkError) {
                    reject(new Error('æ— æ³•è¯†åˆ«æ–‡ä»¶ç¼–ç ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ä¸­æ–‡æ–‡æœ¬'))
                  }
                }
              } catch (error) {
                reject(new Error('æ–‡ä»¶è§£ç å¤±è´¥ï¼š' + error.message))
              }
            }
            reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'))
            reader.readAsArrayBuffer(file)
            return
          }
          
          const encoding = encodings[index]
          const reader = new FileReader()
          
          reader.onload = (e) => {
            const content = e.target.result
            // æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«ä¹±ç 
            if (!containsGarbledText(content)) {
              console.log(`æˆåŠŸä½¿ç”¨ç¼–ç  ${encoding} è¯»å–æ–‡ä»¶`)
              resolve(content)
            } else {
              console.log(`ç¼–ç  ${encoding} æ£€æµ‹åˆ°ä¹±ç ï¼Œå°è¯•ä¸‹ä¸€ä¸ªç¼–ç `)
              // å¦‚æœæ£€æµ‹åˆ°ä¹±ç ï¼Œå°è¯•ä¸‹ä¸€ä¸ªç¼–ç 
              tryNextEncoding(index + 1)
            }
          }
          
          reader.onerror = () => {
            console.log(`ç¼–ç  ${encoding} è¯»å–å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªç¼–ç `)
            // å½“å‰ç¼–ç è¯»å–å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª
            tryNextEncoding(index + 1)
          }
          
          // ä½¿ç”¨æŒ‡å®šçš„ç¼–ç è¯»å–æ–‡ä»¶
          reader.readAsText(file, encoding)
        }
        
        // å¼€å§‹å°è¯•ç¼–ç 
        tryNextEncoding(0)
      })
    }
    
    // æ£€æµ‹æ–‡æœ¬æ˜¯å¦åŒ…å«ä¹±ç 
    function containsGarbledText(text) {
      // å¸¸è§çš„ä¸­æ–‡ä¹±ç æ¨¡å¼
      const garbledPatterns = [
        /[\uFFFD]/g, // Unicodeæ›¿æ¢å­—ç¬¦
        /[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, // æ§åˆ¶å­—ç¬¦
        /[Ã€-Ã¿]{2,}/g, // è¿ç»­çš„æ‹‰ä¸å­—æ¯æ‰©å±•å­—ç¬¦ï¼ˆå¯èƒ½æ˜¯GBKä¹±ç ï¼‰
        /[ÃƒÃ‚Ã„Ã…Ã†Ã‡ÃˆÃ‰ÃŠÃ‹ÃŒÃÃÃÃÃ‘Ã’Ã“Ã”Ã•Ã–Ã—Ã˜Ã™ÃšÃ›ÃœÃÃÃŸÃ Ã¡Ã¢Ã£Ã¤Ã¥Ã¦Ã§Ã¨Ã©ÃªÃ«Ã¬Ã­Ã®Ã¯Ã°Ã±Ã²Ã³Ã´ÃµÃ¶Ã·Ã¸Ã¹ÃºÃ»Ã¼Ã½Ã¾Ã¿]{2,}/g // æ›´å¤šå¯èƒ½çš„ä¹±ç æ¨¡å¼
      ]
      
      // æ£€æŸ¥ä¸­æ–‡å­—ç¬¦æ¯”ä¾‹ï¼ˆå¦‚æœæ–‡æœ¬å¾ˆé•¿ä½†ä¸­æ–‡å­—ç¬¦å¾ˆå°‘ï¼Œå¯èƒ½æ˜¯ä¹±ç ï¼‰
      const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || []
      const totalChars = text.length
      const chineseRatio = chineseChars.length / totalChars
      
      // å¦‚æœæ–‡æœ¬é•¿åº¦è¶…è¿‡100å­—ç¬¦ä½†ä¸­æ–‡æ¯”ä¾‹ä½äº5%ï¼Œå¯èƒ½æœ‰é—®é¢˜
      if (totalChars > 100 && chineseRatio < 0.05) {
        return true
      }
      
      // æ£€æŸ¥ä¹±ç æ¨¡å¼
      for (const pattern of garbledPatterns) {
        if (pattern.test(text)) {
          return true
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦åŒ…å«ç”¨æˆ·æåˆ°çš„ç‰¹å®šä¹±ç æ¨¡å¼
      if (text.includes('ï¿½ï¿½é±¨ï¿½æ£ºï¿½ï¿½ï¿½Ò±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¶ï¿½ï¿½ï¿½ï¿½ï¿½')) {
        return true
      }
      
      return false
    }

    // CSVæ ‡æ³¨æ–‡ä»¶ä¸Šä¼ ç›¸å…³å‡½æ•°
    function handleCsvUpload(event) {
      const files = event.target.files
      if (files.length > 0) {
        csvFile.value = files[0]
      }
      event.target.value = '' // æ¸…ç©ºinputä»¥ä¾¿å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
    }

    function removeCsvFile() {
      csvFile.value = null
      csvUploadStatus.value = ''
    }

    async function uploadCsvAnnotations() {
      if (!csvFile.value) {
        alert('è¯·å…ˆé€‰æ‹©CSVæ–‡ä»¶')
        return
      }

      csvUploadStatus.value = 'æ­£åœ¨ä¸Šä¼ CSVæ ‡æ³¨æ–‡ä»¶...'
      
      try {
        const formData = new FormData()
        formData.append('file', csvFile.value)
        
        const res = await fetch('/api/annotations/upload', {
          method: 'POST',
          body: formData
        })
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`)
        }
        
        const result = await res.json()
        csvUploadStatus.value = 'CSVæ ‡æ³¨æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼'
        
        // ä¸Šä¼ æˆåŠŸåè‡ªåŠ¨è§¦å‘é‡è®­ç»ƒ
        setTimeout(async () => {
          await triggerRetrain()
        }, 1000)
        
      } catch (error) {
        csvUploadStatus.value = 'CSVæ–‡ä»¶ä¸Šä¼ å¤±è´¥'
        alert('CSVæ ‡æ³¨æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š' + error.message)
        console.error('CSVä¸Šä¼ é”™è¯¯:', error)
      }
    }

    // è§„åˆ™ç®¡ç†ç›¸å…³å‡½æ•°
    async function loadRules() {
      try {
        // è¿™é‡Œéœ€è¦æ·»åŠ åç«¯APIæ¥è·å–è§„åˆ™
        // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        const mockRules = [
          {
            name: 'LVEFæå–è§„åˆ™',
            keywords: ['LVEF', 'å°„è¡€åˆ†æ•°', 'å·¦å®¤å°„è¡€åˆ†æ•°'],
            regex: 'LVEF[ï¼š:\\s]*([0-9]+)%'
          },
          {
            name: 'å·¦å®¤æ”¶ç¼©åŠŸèƒ½è§„åˆ™',
            keywords: ['å·¦å®¤æ”¶ç¼©åŠŸèƒ½', 'æ”¶ç¼©åŠŸèƒ½', 'å¿ƒå®¤æ”¶ç¼©'],
            regex: 'å·¦å®¤æ”¶ç¼©åŠŸèƒ½[ï¼š:\\s]*(é™ä½|å‡å¼±|æ­£å¸¸|ä¸‹é™)'
          }
        ]
        rules.value = mockRules
      } catch (error) {
        console.error('åŠ è½½è§„åˆ™å¤±è´¥:', error)
        alert('åŠ è½½è§„åˆ™å¤±è´¥ï¼š' + error.message)
      }
    }

    function editRule(index) {
      const rule = rules.value[index]
      currentRule.name = rule.name
      currentRule.keywordsText = rule.keywords ? rule.keywords.join('\\n') : ''
      currentRule.regex = rule.regex || ''
      currentRule.index = index
      showEditRuleModal.value = true
    }

    function deleteRule(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
        rules.value.splice(index, 1)
        // è¿™é‡Œéœ€è¦æ·»åŠ åç«¯APIæ¥ä¿å­˜è§„åˆ™å˜æ›´
        alert('è§„åˆ™åˆ é™¤æˆåŠŸï¼ˆå‰ç«¯æ¼”ç¤ºï¼‰')
      }
    }

    function saveRule() {
      if (!currentRule.name.trim()) {
        alert('è¯·è¾“å…¥è§„åˆ™åç§°')
        return
      }

      const keywords = currentRule.keywordsText
        .split('\\n')
        .map(k => k.trim())
        .filter(k => k.length > 0)

      const newRule = {
        name: currentRule.name.trim(),
        keywords: keywords,
        regex: currentRule.regex.trim()
      }

      if (showEditRuleModal.value && currentRule.index >= 0) {
        // ç¼–è¾‘ç°æœ‰è§„åˆ™
        rules.value[currentRule.index] = newRule
      } else {
        // æ·»åŠ æ–°è§„åˆ™
        rules.value.push(newRule)
      }

      // è¿™é‡Œéœ€è¦æ·»åŠ åç«¯APIæ¥ä¿å­˜è§„åˆ™
      alert('è§„åˆ™ä¿å­˜æˆåŠŸï¼ˆå‰ç«¯æ¼”ç¤ºï¼‰')
      closeRuleModal()
    }

    function closeRuleModal() {
      showAddRuleModal.value = false
      showEditRuleModal.value = false
      currentRule.name = ''
      currentRule.keywordsText = ''
      currentRule.regex = ''
      currentRule.index = -1
    }

    // å¤„ç†å†å²è®°å½•ç›¸å…³å‡½æ•°
    function loadHistory() {
      // ä»localStorageåŠ è½½å†å²è®°å½•
      try {
        const savedHistory = localStorage.getItem('extractionHistory')
        if (savedHistory) {
          historyRecords.value = JSON.parse(savedHistory)
        } else {
          historyRecords.value = []
        }
      } catch (error) {
        console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error)
        historyRecords.value = []
      }
    }

    function clearHistory() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¤„ç†å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        historyRecords.value = []
        localStorage.removeItem('extractionHistory')
        alert('å†å²è®°å½•å·²æ¸…ç©º')
      }
    }

    function addHistoryRecord(results, status = 'success', error = null) {
      const record = {
        timestamp: new Date().toLocaleString('zh-CN'),
        documentCount: results.length,
        extractedParams: results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0),
        status: status,
        error: error
      }
      
      historyRecords.value.unshift(record) // æ·»åŠ åˆ°å¼€å¤´
      
      // åªä¿ç•™æœ€è¿‘50æ¡è®°å½•
      if (historyRecords.value.length > 50) {
        historyRecords.value = historyRecords.value.slice(0, 50)
      }
      
      // ä¿å­˜åˆ°localStorage
      try {
        localStorage.setItem('extractionHistory', JSON.stringify(historyRecords.value))
      } catch (error) {
        console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error)
      }
    }

    // è®¡ç®—å±æ€§ï¼šæˆåŠŸæ¬¡æ•°
    const successCount = Vue.computed(() => {
      return historyRecords.value.filter(r => r.status === 'success').length
    })
    
    // è®¡ç®—å±æ€§ï¼šå¤±è´¥æ¬¡æ•°
    const failureCount = Vue.computed(() => {
      return historyRecords.value.filter(r => r.status === 'failed').length
    })

    async function processSingle(){
      const startTime = Date.now()
      
      // é‡ç½®è¿›åº¦çŠ¶æ€
      processingProgress.startTime = Date.now()
      processingProgress.estimatedTime = '--'
      
      try {
        updateProgress(30, 'æ­£åœ¨å¤„ç†å•ä¸ªæ–‡æ¡£...')
        
        const payload = {documents:[{doc_id:docId.value, raw_text:rawText.value}]}
        const res = await fetch('/api/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`)
        }
        
        updateProgress(80, 'æ­£åœ¨è§£æå¤„ç†ç»“æœ...')
        const j = await res.json()
        results.value = j.results
        
        const processingTime = ((Date.now() - startTime) / 1000).toFixed(2)
        const extractedParams = j.results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)
        
        updateProgress(100, 'å¤„ç†å®Œæˆï¼')
        showToastMessage(`å•ä¸ªæ–‡æ¡£å¤„ç†å®Œæˆï¼æå–åˆ° ${extractedParams} ä¸ªå‚æ•°ï¼Œè€—æ—¶ ${processingTime} ç§’`, 'success')
        showResultSummary(j.results, processingTime)
        
        // æ›´æ–° failures
        await loadFailures()
        // æ·»åŠ å†å²è®°å½•
        addHistoryRecord(j.results, 'success')
        
        // 2ç§’åéšè—è¿›åº¦æ¡
        setTimeout(() => {
          processingProgress.show = false
          processingProgress.value = 0
          processingProgress.startTime = null
          processingProgress.estimatedTime = '--'
        }, 2000)
        
      } catch (error) {
        processingProgress.show = false
        processingProgress.value = 0
        processingProgress.startTime = null
        processingProgress.estimatedTime = '--'
        showToastMessage(`æ–‡æ¡£å¤„ç†å¤±è´¥ï¼š${error.message}`, 'error')
        console.error('å¤„ç†å¤±è´¥:', error)
        addHistoryRecord([], 'failed', error.message)
      }
    }

    async function batchProcess(){
      const startTime = Date.now()
      
      // é‡ç½®è¿›åº¦çŠ¶æ€
      processingProgress.startTime = Date.now()
      processingProgress.estimatedTime = '--'
      
      try {
        updateProgress(20, 'æ­£åœ¨å‡†å¤‡æ‰¹é‡å¤„ç†æ•°æ®...')
        
        // ç®€å•ç¤ºä¾‹æ‰¹é‡
        const docs = [
          {doc_id:'A', raw_text:'æ£€æŸ¥æŠ¥å‘Šï¼šå·¦å®¤å£å¼¥æ¼«æ€§è¿åŠ¨å‡å¼± å·¦å®¤æ”¶ç¼©åŠŸèƒ½é™ä½ï¼ˆLVEF: 40%ï¼‰ å¤‡æ³¨: æ— å…¶ä»–å¼‚å¸¸'},
          {doc_id:'B', raw_text:'è¶…å£°æ˜¾ç¤ºï¼šLVEF=55%ï¼Œèˆ’å¼ åŠŸèƒ½æ­£å¸¸ã€‚å·¦å¿ƒæˆ¿å¢å¤§ã€‚'},
          {doc_id:'C', raw_text:'å¿ƒç”µå›¾ï¼šçª¦æ€§å¿ƒå¾‹ï¼ŒSTæ®µè½»å¾®æŠ¬é«˜ã€‚è¯„ä¼°ï¼šå¿ƒè‚Œç¼ºè¡€å¯èƒ½ã€‚'},
          {doc_id:'D', raw_text:'ç—…å†å°ç»“ï¼šæ‚£è€…ä¸»è¯‰èƒ¸é—·ï¼Œå¿ƒå®¤è‚Œæ”¶ç¼©åŠ›å‡å¼±ï¼Œå°„è¡€åˆ†æ•°å¤§çº¦ä¸º 38% å·¦å³ã€‚'},
          {doc_id:'E', raw_text:'å¤‡æ³¨ï¼šLVEFå¤§çº¦å››æˆã€‚'}
        ]
        
        updateProgress(50, 'æ­£åœ¨å¤„ç†æ‰¹é‡æ–‡æ¡£...')
        const res = await fetch('/api/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({documents:docs})})
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`)
        }
        
        updateProgress(80, 'æ­£åœ¨è§£æå¤„ç†ç»“æœ...')
        const j = await res.json()
        results.value = j.results
        
        const processingTime = ((Date.now() - startTime) / 1000).toFixed(2)
        const extractedParams = j.results.reduce((total, r) => total + (r.extracted ? r.extracted.length : 0), 0)
        
        updateProgress(100, 'æ‰¹é‡å¤„ç†å®Œæˆï¼')
        showToastMessage(`æ‰¹é‡å¤„ç†å®Œæˆï¼æˆåŠŸå¤„ç† ${docs.length} ä¸ªæ–‡æ¡£ï¼Œæå–åˆ° ${extractedParams} ä¸ªå‚æ•°ï¼Œè€—æ—¶ ${processingTime} ç§’`, 'success')
        showResultSummary(j.results, processingTime)
        
        await loadFailures()
        // æ·»åŠ å†å²è®°å½•
        addHistoryRecord(j.results, 'success')
        
        // 2ç§’åéšè—è¿›åº¦æ¡
        setTimeout(() => {
          processingProgress.show = false
          processingProgress.value = 0
          processingProgress.startTime = null
          processingProgress.estimatedTime = '--'
        }, 2000)
        
      } catch (error) {
        processingProgress.show = false
        processingProgress.value = 0
        processingProgress.startTime = null
        processingProgress.estimatedTime = '--'
        showToastMessage(`æ‰¹é‡å¤„ç†å¤±è´¥ï¼š${error.message}`, 'error')
        console.error('æ‰¹é‡å¤„ç†å¤±è´¥:', error)
        addHistoryRecord([], 'failed', error.message)
      }
    }

    async function loadFailures(){
      const res = await fetch('/api/failures')
      const j = await res.json()
      failures.value = j.failures || []
    }

    function markFailure(r){
      // é¢„å¡«æ³¨é‡Š modal
      anno.doc_id = r.doc_id
      anno.raw_text = r.raw_text
      anno.param_name = ''
      anno.param_value = ''
      annotateModal.value = true
    }

    function openAnnotate(f){
      anno.doc_id = f.doc_id
      anno.raw_text = f.raw_text
      anno.params = [{param_name: '', param_value: ''}]
      annotateModal.value = true
    }

    function addParam() {
      anno.params.push({param_name: '', param_value: ''})
    }

    function removeParam(index) {
      if (anno.params.length > 1) {
        anno.params.splice(index, 1)
      }
    }

    async function submitAnnotation(){
      // è¿‡æ»¤æ‰ç©ºçš„å‚æ•°
      const validParams = anno.params.filter(p => p.param_name.trim() && p.param_value.trim())
      
      if (validParams.length === 0) {
        alert('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªæœ‰æ•ˆçš„å‚æ•°åç§°å’Œå‚æ•°å€¼')
        return
      }

      // ä¸ºæ¯ä¸ªå‚æ•°å•ç‹¬æäº¤æ ‡æ³¨
      for (const param of validParams) {
        const form = new FormData();
        form.append('doc_id', anno.doc_id)
        form.append('raw_text', anno.raw_text)
        form.append('param_name', param.param_name)
        form.append('param_value', param.param_value)
        await fetch('/api/annotations/add',{method:'POST', body: form})
      }
      
      annotateModal.value = false
      
      // æäº¤æ ‡æ³¨åè‡ªåŠ¨è§¦å‘ retrain
      await triggerRetrain()
    }

    async function triggerRetrain(){
      try {
        const response = await fetch('/api/retrain', {method: 'POST'})
        const result = await response.json()
        
        if (result.status === 'applied') {
          alert(`âœ… è§„åˆ™é‡è®­ç»ƒæˆåŠŸï¼\n\nåº”ç”¨äº† ${result.rules_count} æ¡æ–°è§„åˆ™\nåŸºäº ${result.annotations_count} æ¡æ ‡æ³¨æ•°æ®\n\nè§„åˆ™åº“å·²æ›´æ–°ï¼Œå¯ä»¥é‡æ–°å¤„ç†æ–‡æ¡£æµ‹è¯•æ•ˆæœã€‚`)
        } else if (result.status === 'no_annotations') {
          alert('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ ‡æ³¨æ•°æ®\n\nè¯·å…ˆå¯¹å¤±è´¥çš„æ–‡æ¡£è¿›è¡Œäººå·¥æ ‡æ³¨ï¼Œç„¶åå†æ¬¡è§¦å‘é‡è®­ç»ƒã€‚')
        } else if (result.status === 'no_rules_generated') {
          alert(`â„¹ï¸ DeepSeek æœªç”Ÿæˆæ–°è§„åˆ™\n\nåŸºäº ${result.annotations_count} æ¡æ ‡æ³¨æ•°æ®ï¼ŒDeepSeek æœªç”Ÿæˆæ–°è§„åˆ™\nè§„åˆ™åº“ä¿æŒä¸å˜ã€‚`)
        } else if (result.status === 'deepseek_disabled') {
          alert('ğŸ”§ DeepSeek åŠŸèƒ½æœªå¯ç”¨\n\nå¦‚éœ€ä½¿ç”¨è‡ªåŠ¨è§„åˆ™ç”ŸæˆåŠŸèƒ½ï¼Œè¯·å¯ç”¨ DeepSeek API é…ç½®ã€‚')
        } else {
          alert(`æœªçŸ¥çŠ¶æ€: ${result.status}\n\n${result.message || 'è¯·æ£€æŸ¥åç«¯æ—¥å¿—'}`)
        }
      } catch (error) {
        alert('âŒ é‡è®­ç»ƒè¯·æ±‚å¤±è´¥ï¼š' + error.message)
      }
    }

    async function downloadStructured(){
      const res = await fetch('/api/structured')
      if (res.ok){
        const blob = await res.blob()
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url; a.download = 'structured.json'; document.body.appendChild(a); a.click(); a.remove();
      } else {
        alert('å°šæœªç”Ÿæˆ structured.json')
      }
    }

    // init
    loadFailures()
    loadHistory()

    return {
      docId, rawText, processSingle, batchProcess, results, failures, markFailure, 
      annotateModal, anno, openAnnotate, addParam, removeParam, submitAnnotation, downloadStructured,
      uploadedFiles, processingStatus, handleFileUpload, removeFile, processUploadedFiles,
      csvFile, csvUploadStatus, handleCsvUpload, removeCsvFile, uploadCsvAnnotations,
      rules, showAddRuleModal, showEditRuleModal, currentRule, loadRules, editRule, deleteRule, saveRule, closeRuleModal,
      historyRecords, successCount, failureCount, loadHistory, clearHistory, addHistoryRecord,
      triggerFileInput, triggerCsvInput, triggerRetrain,
      // æ–°å¢å“åº”å¼æ•°æ®å’Œæ–¹æ³•
      processingProgress, resultSummary, toastMessage, toastType, showToast, showVisualization,
      showToastMessage, updateProgress, showResultSummary
    }
  }
}).mount('#app')


</script>
</body>
</html>
